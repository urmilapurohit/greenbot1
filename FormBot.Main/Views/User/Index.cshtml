@model FormBot.Entity.User
@using FormBot.Helper;

@{
    ViewBag.Title = "Index";
}

@{
    bool isAdd = false, isEdit = false, isDelete = false;

    if (TempData.ContainsKey(SystemEnums.TempDataKey.RoleMenu.ToString()))
    {
        ((List<FormBot.Main.Controllers.MenuIdList>
    )TempData[SystemEnums.TempDataKey.RoleMenu.ToString()]).ForEach(d =>
    {
        if (d.MenuId == (int)SystemEnums.MenuId.UserAdd.GetHashCode()) { isAdd = true; }
        if (d.MenuId == (int)SystemEnums.MenuId.UserEdit.GetHashCode()) { isEdit = true; }
        if (d.MenuId == (int)SystemEnums.MenuId.UserDelete.GetHashCode()) { isDelete = true; }
    });
    }
}

<div id="msgSection">
    @Html.RenderMessages()
</div>
<div class="container-fluid">
    <div class="title">
        <h1>All Users</h1>
        @if (isAdd)
        {
            <a href="@Url.Action("Create","User")" class="btn primary pull-right icon-btn"><span class="sprite-img add_ic"></span>Create New User</a>

        }

        <input type="button" id="btnSendMail" value="Send Mail" class="primary pull-right mail_ic" data-toggle="modal" data-target="" data-backdrop="static" data-keyboard="false" onclick="SendMail();" />
    </div>

    <div class="alert alert-success alert-dismissible" role="alert" id="errorMsgRegion" style="display: none">
        <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
    </div>

    <form class="form-block" style="margin-top:10px;">
        <div class="col-sm-6 col-md-4 col-lg-3">
            <div class="form-group">
                <label class="control-label">Name:</label>
                <input type="text" id="txtName" class="form-control" maxlength="100" onkeyup="if (event.keyCode == 13)document.getElementById('btnSearch').click()">
            </div>
        </div>
        <div class="col-sm-6 col-md-4 col-lg-3">
            <div class="form-group">
                <label class="control-label">UserName:</label>
                <input type="text" id="txtUserName" class="form-control" maxlength="100" onkeyup="if (event.keyCode == 13)document.getElementById('btnSearch').click()">
            </div>
        </div>
        <div class="col-sm-6 col-md-4 col-lg-3">
            <div class="form-group">
                <label class="control-label">Email:</label>
                <input type="text" id="txtEmail" class="form-control" maxlength="256" onkeyup="if (event.keyCode == 13)document.getElementById('btnSearch').click()">
            </div>
        </div>
        @if (Model.UserTypeID == 1)
        {
            <div class="col-sm-6 col-md-4 col-lg-3">
                <div class="form-group">
                    <label class="control-label">User Type:</label>
                    @Html.DropDownListFor(model => model.UserTypeID, new List<SelectListItem>(), new { id = "UserTypeId", @class = "form-control" })
                </div>
            </div>
            <div class="col-sm-6 col-md-4 col-lg-3">
                <div class="form-group">
                    <label class="control-label">Reseller:</label>
                    @Html.DropDownListFor(model => model.ResellerID, new List<SelectListItem>(), new { id = "ResellerId", @class = "form-control" })
                </div>
            </div>
            <div class="col-sm-6 col-md-4 col-lg-3">
                <div class="form-group">
                    <label class="control-label">Solar Company:</label>
                    @*@Html.DropDownListFor(model => model.SolarCompanyId, new List<SelectListItem>(), new { id = "SolarCompanyId", @class = "form-control" })*@
                    <input type="hidden" id="hdnsolarCompanyid" />
                    <input type="text" id="txtCompanyName" name="txtCompanyName" class="form-control" maxlength="50" onkeyup="if (event.keyCode == 13)document.getElementById('btnSearch').click()" />
                </div>
            </div>
        }
        <div class="col-sm-6 col-md-4 col-lg-3">
            <div class="form-group">
                <label class="control-label">Role:</label>
                @Html.DropDownListFor(model => model.RoleID, new List<SelectListItem>(), new { id = "RoleID", @class = "form-control" })
            </div>
        </div>
        <div class="col-sm-6 col-md-4 col-lg-3">
            <div class="form-group">
                <label class="control-label">Company ABN:</label>
                <input type="text" id="txtCompanyabn" class="form-control" maxlength="50" onkeyup="if (event.keyCode == 13)document.getElementById('btnSearch').click()">
            </div>
        </div>
        <div class="col-sm-6 col-md-4 col-lg-3">
            <div class="form-group">
                <label class="control-label">Mobile/Phone:</label>
                <input type="text" id="txtMobile" class="form-control" maxlength="256" onkeyup="if (event.keyCode == 13)document.getElementById('btnSearch').click()">
            </div>
        </div>

        <div class="col-sm-6 col-md-4 col-lg-3">
            <label class="control-label">IsSaasUser:</label>
            <select class="form-control valid" id="IsSaasUser" name="IsSaasUser">
                <option value="All">All</option>
                <option value="1">Yes</option>
                <option value="0">No</option>
            </select>
        </div>

        <div class="col-sm-6 col-md-4 col-lg-3">
            <div class="form-group">
                <label class="control-label">Is Active:</label><br />
                <input type="checkbox" name="IsActive" id="btnchkIsActive" checked="checked" onkeyup="if (event.keyCode == 13)document.getElementById('btnSearch').click()" />
            </div>
        </div>
        <div class="form-group col-xs-12">
            <input type="button" id="btnSearch" value="Search" class="primary search_ic" onclick="SearchUsers();">

            <div class="default btn icon-btn" onclick="ResetSearchFilters();">
                <span class="sprite-img reset_ic"></span>
                <input type="button" id="btnReset" value="Reset" class="">
            </div>


        </div>
    </form>
    @if (Model.UserTypeID == 1)
    {
        <div class="form-group col-xs-12">
            <input type="button" id="btnRestore" value="Restore User" class="primary pull-right">
        </div>
    }
    <div class="grid_topbar col-xs-12" ">
        <p class="job_result" id="numRecords"></p>
    </div>

    <div class="row">
        <div id="grid" class="col-xs-12">
            <!-- Grid start -->
            <div class="table-responsive">
                <table id="datatable" class="table table-hover">
                    <thead>
                        <tr>
                            <th width="3%" style="background-image:none !important;"><input type="checkbox" id="chkAll" name="select_all"></th>
                            <th width="12%"><span>@Html.DisplayName("Name")</span></th>
                            <th width="12%"><span>@Html.DisplayName("UserName ")</span></th>
                            <th width="5%"><span>@Html.DisplayName("Active")</span></th>
                            <th width="15%"><span>@Html.DisplayName("UserType")</span></th>
                            <th width="14%"><span>@Html.DisplayName("Email ")</span></th>
                            <th width="14%"><span>@Html.DisplayName("Mobile ")</span></th>
                            <th width="14%"><span>@Html.DisplayName("Phone ")</span></th>
                            <th width="12%"><span>@Html.DisplayName("Solar Company")</span></th>
                            <th width="12%"><span>@Html.DisplayName("Reseller")</span></th>
                            <th width="10%"><span>@Html.DisplayName("Last LogIn")</span></th>
                            <th width="10%"><span>@Html.DisplayName("Role")</span></th>
                            <th width="10%"><span>@Html.DisplayName("IsSaasUser")</span></th>
                            <th width="5%" class="action">@Html.DisplayName("Action")</th>
                        </tr>
                    </thead>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade newemail-modal ashish" id="emailbox" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button aria-label="Close" data-dismiss="modal" class="close newEmailClose" type="button" style="margin-right:9px !important;margin-top:5px !important;">
                    <img alt="" src="@Url.Content("~/images/close-btn.png")">
                </button>
                <div class="email-hed"> <a href=" #" class="admin-id"> <img alt="" src="@Url.Content("~/images/admin-id-icon.png")" class="mail-icon"><span id="emailBoxEmailId">Admin@tatvasoft.com</span>  </a> </div>
            </div>
            <div class="form-border">
                <ul class="navbar-nav">
                    <!--<li class="active"><a href="#" title="Back to List" data-dismiss="modal" aria-label="Close"> <img class="icon" src="images/back-list.png" alt="Back to List">Back to List</a></li>-->
                    <li class="active" id="SendMail"><a href="javascript:void(0)" title="Send"> <img class="icon" src="@Url.Content("~/images/send-icon.png")" alt="Send">Send</a></li>
                    <li class="active"> <a href="javascript:void(0)" title="Save" id="SaveMail"><img class="icon" src="@Url.Content("~/images/save-icon.png")" alt="Save">Save</a> </li>
                </ul>
            </div>
            <div class="modal-body">
                <input type="hidden" name="guid" id="guid" value="" />
                <!-- menu End -->
                <div class="mail-box-input">
                    <form class="form-horizontal">
                        <div class="form-group">
                            <label class="col-sm-1 control-label">To</label>
                            <div class="col-sm-11">
                                <input type="text" class="form-control" id="ToMail">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-1 control-label">Cc</label>
                            <div class="col-sm-11">
                                <input type="text" class="form-control" id="CcMail">
                                <!--<div class="text-right"><a class="show-bcc" href="#" title="">Show BCc</a></div>-->
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-1 control-label">Bcc</label>
                            <div class="col-sm-11">
                                <input type="text" class="form-control" id="BccMail">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-1 control-label">Subject</label>
                            <div class="col-sm-11">
                                <input type="text" class="form-control" id="SubjectMail" maxlength="255">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-1 control-label">Body</label>
                            <div class="col-sm-11">
                                <div id="editor">
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-1 control-label">Selected Files :</label>
                            <div class="col-sm-11">
                                <table class="table table-bordered" id="tblSelectedFile">
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-1 control-label">Attach File :</label>
                            <div class="col-sm-11">
                                <table class="uf">
                                    <tr>
                                        <td><input id="uploadFile" placeholder="Choose File" class="form-control" disabled="disabled" /></td>
                                        <td width="70" style="vertical-align:top;">
                                            <div class="fileUpload primary">
                                                <span>Upload</span>
                                                <input id="uploadBtn" type="file" class="upload" />
                                            </div>
                                        </td>
                                    </tr>
                                </table>
                                <script type="text/javascript">
                                    document.getElementById("uploadBtn").onchange = function () {
                                        //document.getElementById("uploadFile").value = this.value;
                                        $("#uploadFile").val("");
                                    };
                                </script>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

</div>
@*@Styles.Render("~/datatableCSS")*@
@section scripts{
    @*<script src="~/Scripts/jquery-ui-1.0.js"></script>
        <script src="~/Scripts/jquery.fileupload.js"></script>
        <script src="~/Scripts/FormBot.js"></script>
        <script src="~/Scripts/bootstrap.min.js"></script>*@
    <script type="text/javascript" src="~/Areas/Email/js/ckeditor/ckeditor.js"></script>
    <script type="text/javascript" src="~/Areas/Email/js/ckeditor/samples/js/sample.js"></script>

    @*@Scripts.Render("~/bundles/bootstrap")*@
    @*@Scripts.Render("~/datatableJs")
        @Scripts.Render("~/bundles/jqueryval")*@
    <script>
        initSample();
        var chkCount=0;
        var selectedRows = [];
        var toggleId;
        var solarCompanyList = [];
        $(document).ready(function () {
            var userTypeId = localStorage.getItem('User_UserTypeId');
            getRole(userTypeId);

            // Initialize select2
            $("#ResellerId").select2();

            $('#txtCompanyName').autocomplete({
                minLength: 0,
                source: function (request, response) {
                    var data = [];
                    $("#hdnsolarCompanyid").val(0);
                    $.each(solarCompanyList, function (key, value) {
                        if (value.text.toLowerCase().indexOf($("#txtCompanyName").val().toLowerCase()) > -1) {
                            data.push({ Title: value.text, id: value.value });
                        }
                    });

                    response($.map(data, function (item) {
                        return { label: item.Title, value: item.Title, id: item.id };
                    }))
                },
                select: function (event, ui) {
                    $("#hdnsolarCompanyid").val(ui.item.id); // save selected id to hidden input
                }
            }).on('focus', function () { $(this).keydown(); });

            $.ui.autocomplete.prototype._renderItem = function (ul, item) {
                var re = new RegExp($.trim(this.term.toLowerCase()));
                var t = item.label.replace(re, "<span style='font-weight:600;'>" + $.trim(this.term.toLowerCase()) +
                    "</span>");
                return $("<li style='font-size:14px;'></li>")
                    .data("item.autocomplete", item)
                    .append("<a>" + t + "</a>")
                    .appendTo(ul);
            };

            SetParamsFromLocalStorage();
            $("#txtName").focus();
            $('#datatable').DataTable({
                iDisplayLength: 10,
                lengthMenu:@ProjectConfiguration.GetPageSize,
                language: {
                    sLengthMenu: "Page Size: _MENU_"
                },
                columns: [
                        { 'data': 'Id',
                            "orderable": false,
                            "render": function (data, type, full, meta) {
                                if($('#chkAll').prop('checked')==true){
                                    return '<input type="checkbox" id="chk_'+full.Id+'" checked email="'+full.Email+'">';
                                }
                                else{
                                    return '<input type="checkbox" id="chk_'+full.Id+'" email="'+full.Email+'">';
                                }
                            }
                        },

                        { 'data': 'Name' },
                        { 'data': 'UserName'},

                        { 'data': 'IsActive',
                            "render": function (data, type, full, meta) {
                                if(full.IsActive==1){
                                    return '<img src="../Images/active.png" alt="Active" title="Active">'
                                }
                                else{
                                    return '<img src="../Images/inactive.png" alt="In Active" title="In Active">'
                                }
                            },
                            "orderable": false
                        },

                        { 'data': 'UserTypeName',
                            visible: @Model.UserTypeID==1?true:false,
                            "render": function (data, type, full, meta) {
                                imginfo = 'background:url(../Images/ic-info.png) no-repeat center; text-decoration:none; cursor:default;';
                                return data + ' ' + '<a id="'+full.UserId+'"  onmouseout="HideToolTip();" onmouseover="ShowToolTip(this.id);" onclick="clickToggle(this.id);" " style="' + imginfo + '" data-toggle="tooltip" data-placement="bottom" title="' +full.UserInfo+'" >&nbsp; &nbsp; &nbsp; &nbsp;</a>';
                            }
                        },

                        { 'data': 'Email' },
                        { 'data': 'Mobile' },
                        { 'data': 'Phone' },
                        { 'data': 'SolarCompany',
                            visible: @Model.UserTypeID==1?true:false
                        },
                        { 'data': 'ResellerName',
                            visible: @Model.UserTypeID==1?true:false
                        },

                        { 'data': 'LastLogIn',
                            "render": function (data, type, full, meta) {
                                //return ConvertToDate(data);
                                return ConvertToDateWithFormat(data,'@FormBot.Helper.ProjectConfiguration.GetDateFormat');
                            }
                        },
                    { 'data': 'Role' },
                    {
                        'data': 'IsSAASUser',
                        "render": function (data, type, full, meta) {
                            if (data) {
                                return "Yes";
                            }
                            else {
                                return "No"
                            }
                        }
                    },
                        {
                            'data': 'Id',
                            "render": function (data, type, full, meta) {
                                var editHref ='';
                                @if(isEdit)
                                 {
                                     <text>
                                imgedit = 'background:url(../Images/edit-icon.png) no-repeat center; text-decoration:none;';
                                editHref = ("@Url.Action("Edit", "User")" + "/" + full.Id);
                                title="Edit";
                                </text>
                                 }
                                 else
                                 {
                                <text>
                                imgedit = 'background:url(../Images/view-icon.png) no-repeat center; text-decoration:none;';
                                editHref = ("@Url.Action("View", "User")" + "/" + full.Id);
                                title="View";
                                </text>
                                }
                                imgdelete = 'background:url(../Images/delete-icon.png) no-repeat center; text-decoration:none;';
                                var deleteHref = "javascript:DeleteUser('" + full.Id + "')";
                                var returnHTML = '';

                                returnHTML +=  '<a href="' + editHref + '" class="action edit" style="' + imgedit + '" title="'+title+'">' + '&nbsp; &nbsp; &nbsp; &nbsp;' + '</a>' + '&nbsp;&nbsp;';


                                @if(isDelete)
                                {
                                   <text>
                                returnHTML +=  '<a href="' + deleteHref + '" class="action delete" style="' + imgdelete + '" title="Delete">' + '&nbsp; &nbsp; &nbsp; &nbsp;' + '</a>';
                                </text>
                                }
                                return returnHTML;
                            },
                            "orderable": false
                        },
                ],

                dom: "<<'table-responsive tbfix't><'paging grid-bottom prevar'p><'bottom'l><'clear'>>",
                initComplete: function (settings, json) {
                    $('.grid-bottom span:first').attr('id', 'spanMain');
                    $("#spanMain span").html("");
                },
                bServerSide: true,
                sAjaxSource: '@Url.Action("GetUserList", "User")',

                "fnDrawCallback": function () {
                    if($('#chkAll').prop('checked')==true){
                        chkCount=$('#datatable >tbody >tr').length;
                    }
                    else{
                        chkCount=0;
                    }
                    $("#datatable_wrapper").find(".bottom").find(".dataTables_paginate").remove();
                    $(".paging a.previous").html("&nbsp");
                    $(".paging a.next").html("&nbsp");
                    $('.grid-bottom span:first').attr('id', 'spanMain');
                    $("#spanMain span").html("");
                    $(".ellipsis").html("...");

                    if ($(".paging").find("span").length >= 1) {
                        $("#datatable_length").show();
                    } else if ($("#datatable").find("tr").length >11) { $("#datatable_length").show();  } else { $("#datatable_length").hide(); }

                    //--------To show display records from total records-------------------
                    var table = $('#datatable').DataTable();
                    var info = table.page.info();
                    if(info.recordsTotal==0){
                        document.getElementById("numRecords").innerHTML = '<b>' + 0 + '</b>  of  <b>' + info.recordsTotal +'</b> User(s) found';
                    }
                    else{
                        document.getElementById("numRecords").innerHTML = '<b>' + $('#datatable >tbody >tr').length + '</b>  of  <b>' + info.recordsTotal +'</b> User(s) found';
                    }
                    //------------------------------------------------------------------------------------------------------------------------------

                    $('[data-toggle="tooltip"]').tooltip();
                },
                "fnServerParams": function (aoData) {  //These are the extra parameters for our custom filters
                    var SelectedUserTypeId = '';
                    var name = '';
                    if(@Model.UserTypeID == 1){
                        SelectedUserTypeId = '1,2,3,5,6,8,9';  //for FSA
                    }
                    else if(@Model.UserTypeID==2){
                        SelectedUserTypeId = '5';    //for Reseller
                    }
                    else if(@Model.UserTypeID==4 || @Model.UserTypeID==6){
                        SelectedUserTypeId = '8';
                    }

                    aoData.push({ "name": "SelectedUserTypeId", "value": SelectedUserTypeId });
                    aoData.push({ "name": "view", "value": 1 });
                    aoData.push({ "name": "name", "value": $("#txtName").val() });
                    aoData.push({ "name": "username", "value": $("#txtUserName").val() });
                    aoData.push({ "name": "email", "value": $("#txtEmail").val() });
                    if(@Model.UserTypeID == 1){
                        aoData.push({ "name": "usertype", "value": localStorage.getItem('User_UserTypeId') });
                        aoData.push({ "name": "Reseller", "value": localStorage.getItem('User_ResellerId') });
                        aoData.push({ "name": "solarcompany", "value": localStorage.getItem('User_SolarCompanyId') });
                        aoData.push({ "name": "companyname", "value": localStorage.getItem('User_CompanyName') });
                    }
                    aoData.push({ "name": "active", "value": document.getElementById("btnchkIsActive").checked });
                    aoData.push({ "name": "role", "value": localStorage.getItem('User_RoleID') });
                    aoData.push({ "name": "mobile", "value": $("#txtMobile").val() });
                    aoData.push({ "name": "companyabn", "value": $("#txtCompanyabn").val() });
                    aoData.push({ "name": "IsSaasUser", "value": document.getElementById("IsSaasUser").value });
                }
            });

            var table = $('#datatable').DataTable();

            $('#chkAll').on('click', function () {
                var rows = table.rows({ 'search': 'applied' }).nodes();
                $('input[type="checkbox"]', rows).prop('checked', this.checked);
                chkCount = this.checked ? $('#datatable >tbody >tr').length : 0;
            });

            $('#datatable tbody').on('change', 'input[type="checkbox"]', function () {
                if (this.checked) {
                    chkCount++;
                    if (chkCount == $('#datatable >tbody >tr').length) {
                        $('#chkAll').prop('checked', this.checked)
                    }
                }
                else {
                    chkCount--;
                    $('#chkAll').prop('checked', this.checked)
                }
            });

            $('#btnRestore').click(function(){
                window.location.href=document.location.origin+"/User/RestoreUser"
            })

            $('#ResellerId').change(function(){
                BindSolarCompany($('#ResellerId').val());
            })

            $('#UserTypeId').change(function () {
                var userTypeId = $("#UserTypeId").val();

                getRole(userTypeId);

            })
        });

        if('@Model.UserTypeID'==1)
        {
            FillDropDown('UserTypeId', '@Url.Action("GetUserTypeforFSA", "UserType")', localStorage.getItem('User_UserTypeId'), true,null);
            $('#UserTypeId option:contains("Solar Company Admin")').remove();
           FillDropDown('ResellerId', '@Url.Action("GetReseller", "Reseller")', localStorage.getItem('User_ResellerId'), true, null);
            @*FillDropDown('SolarCompanyId', '@Url.Action("GetSolarCompany", "SolarCompany")', localStorage.getItem('User_SolarCompanyId'), true, null);*@
            BindSolarCompany(localStorage.getItem('User_ResellerId'));
        }
        function getRole(userTypeId) {
            if ('@Model.UserTypeID' == '1') {
                userTypeId = userTypeId;
            }
            else if ('@ProjectSession.UserTypeId' == '2') {
                userTypeId = 5;
            }
            else if ('@ProjectSession.UserTypeId' == '4' || '@ProjectSession.UserTypeId'=='6')
                userTypeId = 8;

             $.ajax({
                    url: '@Url.Action("GetRole", "Role")',
                    type: "get",
                    data: { id: userTypeId },
                    async: false,
                    dataType: "json",
                    contentType: "application/json; charset=utf-8",
                    success: function (data) {
        if (data == 0) {
                            $("#RoleID").empty();
                            $("#RoleID").append('<option value="">' + "Select" + '</option>');
        }
        else {
                            $("#RoleID").empty();
                            $("#RoleID").append('<option value="" selected>' + "Select" + '</option>');

                            $.each(data, function (i, role) {
                                $("#RoleID").append('<option value="' + role.Value + '">' +
                                                                      role.Text + '</option>');
            });

                    }
                },
                });

        }
        function BindSolarCompany(resellerID) {
            var IsCompanyExist=false;
            $.ajax({
                type: 'GET',
                url: '@Url.Action("GetSolarCompanyByResellerId", "SolarCompany")',
                dataType: 'json',
                data: { id: resellerID },
                async: true,
                success: function (solarcompany) {
                    solarCompanyList=[];
                    $.each(solarcompany, function (i, company) {
                        solarCompanyList.push({ value:company.Value,text:company.Text });
                    });

                    $('#txtSolarCompany').autocomplete({
                        minLength: 0,
                        source: function (request, response) {
                            var data = [];
                            $("#hdnsolarCompanyid").val(0);
                            $.each(solarCompanyList, function (key, value) {
                                if (value.text.toLowerCase().indexOf($("#txtSolarCompany").val().toLowerCase()) > -1) {
                                    data.push({ Title: value.text, id: value.value });
                                }
                                if (value.value == localStorage.getItem('User_SolarCompanyId')) {
                                    $("#txtSolarCompany").val(value.text);
                                    $('#hdnsolarCompanyid').val(localStorage.getItem('User_SolarCompanyId'));
                                }
                            });


                            response($.map(data, function (item) {
                                return { label: item.Title, value: item.Title, id: item.id };
                            }));
                        },
                        select: function (event, ui) {
                            $("#hdnsolarCompanyid").val(ui.item.id); // save selected id to hidden input
                        }
                    }).on('focus', function () { $(this).keydown(); });

                    $.ui.autocomplete.prototype._renderItem = function (ul, item) {
                        var re = new RegExp($.trim(this.term.toLowerCase()));
                        var t = item.label.replace(re, "<span style='font-weight:600;'>" + $.trim(this.term.toLowerCase()) +
                            "</span>");
                        return $("<li style='font-size:14px;'></li>")
                            .data("item.autocomplete", item)
                            .append("<a>" + t + "</a>")
                            .appendTo(ul);
                    };
                },
                error: function (ex) {
                    alert('Failed to retrieve Solar Companies.' + ex);
                }
            });
            return false;
        }
        @*FillDropDown('RoleId', '@Url.Action("GetRoleUserTypewise", "Role")', localStorage.getItem('User_RoleId'), true, null);*@



        function ResetSearchFilters() {
            localStorage.setItem('User_Name','');
            localStorage.setItem('User_UserName','');
            localStorage.setItem('User_Email','');

            if('@Model.UserTypeID'==1){
                localStorage.setItem('User_UserTypeId',0);
                localStorage.setItem('User_ResellerId',0);
                localStorage.setItem('User_SolarCompanyId', 0);
                localStorage.setItem('User_CompanyName', '');
                document.getElementById("UserTypeId").selectedIndex = 0;
                document.getElementById("ResellerId").selectedIndex = 0;
                //document.getElementById("SolarCompanyId").selectedIndex = 0;
                $('#hdnsolarCompanyid').val("0");
                $('#searchSolarCompany').val('');
                $("#ResellerId").select2();
            }

            localStorage.setItem('User_IsActive',true);
            localStorage.setItem('User_RoleID',0);
            localStorage.setItem('User_CompanyABN', '');
            localStorage.setItem('User_Mobile', '');
            document.getElementById("RoleID").selectedIndex = 0;
            $('#IsSaasUser').val('All');
            getRole(0);
            SetParamsFromLocalStorage();
            $("#datatable").dataTable().fnDraw();
        }

        function SearchUsers() {
            localStorage.setItem('User_Name',$("#txtName").val());
            localStorage.setItem('User_UserName',$("#txtUserName").val());
            localStorage.setItem('User_Email',$("#txtEmail").val());

            if(@Model.UserTypeID == 1){
                localStorage.setItem('User_UserTypeId',document.getElementById("UserTypeId").value);
                localStorage.setItem('User_ResellerId',document.getElementById("ResellerId").value);
                //localStorage.setItem('User_SolarCompanyId',document.getElementById("SolarCompanyId").value);
                localStorage.setItem('User_SolarCompanyId', $('#hdnsolarCompanyid').val());
                localStorage.setItem('User_CompanyName', $("#txtCompanyName").val());
            }

            localStorage.setItem('User_IsActive',document.getElementById("btnchkIsActive").checked);
            localStorage.setItem('User_RoleID',document.getElementById("RoleID").value);
            localStorage.setItem('User_CompanyABN', $("#txtCompanyabn").val());
            localStorage.setItem('User_Mobile', $("#txtMobile").val());

            $("#datatable").dataTable().fnDraw();
        }

        function ConvertToDate(data){
            if (data != null) {
                var date = new Date(parseInt(data.replace('/Date(', '')));
                return ("0" + date.getDate()).slice(-2) + '/' + ("0" + (date.getMonth() + 1)).slice(-2) + '/' + date.getFullYear();
            }
            else {
                return '';
            }
        }

        function DeleteUser(userid){
            var result = confirm("Are you sure you want to delete this record ?");
            if (result) {
                $.ajax({
                    url: '@Url.Action("DeleteUser", "User")',
                    type: "POST",
                    async: false,
                    data: JSON.stringify({ userId: userid }),
                    dataType: "json",
                    contentType: "application/json; charset=utf-8",
                    success: function (data) {
                        if (data.success) {
                            var strEmailConfigureMsg='';
                            //Email configuration not required
                            if('@ProjectSession.IsUserEmailAccountConfigured'=='False'){
                                strEmailConfigureMsg='(Can not send mail to deleted user because email account is not configured)';
                            }

                            $(".alert").hide();
                            $("#errorMsgRegion").html(closeButton + "User deleted successfully. "+strEmailConfigureMsg);
                            $("#errorMsgRegion").show();

                            $("#datatable").dataTable().fnDraw();
                        }
                    },
                });
            }
        }

        function SendMail(){
            var selectedUser=[];
            $('#datatable tbody input[type="checkbox"]').each(function(){
                if($(this).prop('checked')==true){
                    selectedUser.push(($(this).attr('email')));
                }
            })
            if(selectedUser==null || selectedUser.length==0){
                alert("Please select any user.");
            }
            else if(selectedUser!=null && selectedUser.length>25){
                alert("Please select Users upto 25.");
            }
            else if(selectedUser!=null && selectedUser.length > 0 && selectedUser.length < 25){
                var result = confirm("Are you sure you want to send mail to selected users ?");
                if (result) {
                    $("#emailBoxEmailId").html('@ViewBag.email');
                    //$("#ToMail").val(selectedUser.join(";"));
                    $("#ToMail").val('@Model.ToEmailAddress');
                    $("#BccMail").val(selectedUser.join(";"));
                    $('#emailbox').modal('show');
                    $("#guid").val(guid());
                }
            }
        }
        function CreateCommaSeparetedArray(element) {
            var x = element;
            x = x.replace(/,/g,";");
            var emailList = x.trim().replace(/(^;)|(;$)/g, "").split(";");
            emailList = cleanArray(emailList);
            return emailList;
        }

        function cleanArray(actual) {
            var newArray = new Array();
            for (var i = 0; i < actual.length; i++) {
                if (actual[i]) {
                    newArray.push(actual[i]);
                }
            }
            return newArray;
        }

        function validateForm(emailList,message,lengthExceedMessage) {
            var flag = true;
            var testing;
            emailList.forEach(function(i,j){
                var filter = /^([\w-\.]+)@@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.)|(([\w-]+\.)+))([a-zA-Z]{2,4}|[0-9]{1,3})(\]?)$/
                testing = i.trim();
                if (filter.test(testing)) {
                }
                else {
                    flag = false;
                }
            });
            if (emailList.length == 0) {
                flag = false;
            }

            if (flag == false) {
                alert(message);
            }else {
                if (emailList.length > 25) {
                    alert(lengthExceedMessage);
                    flag = false;
                }
            }

            return flag;
        }

        $("#ToMail,#CcMail,#BccMail").keypress(function (event) {
            if (event.which == 44) {event.preventDefault();
                $(this).val($(this).val() + ";");
            }
            if (event.which == 9) {alert('1');
                $(this).val($(this).val().replace(",",";"));
            }
        });

        $("#ToMail,#CcMail,#BccMail").blur(function (event) {
            $(this).val($(this).val().replace(/,/g,";"));
        });

        $("#SendMail").click(function () {
            var JsonRequestData = {
                QueuedEmailId : "",
                FromEmail : "",
                ToEmail: "",
                CC: "",
                Bcc: "",
                Subject: "",
                Body: "",
                Guid: "",
                IsSent: "",
                SentTries: "",
                SentOn: "",
                CreatedDate: "",
                ModifiedDate: ""
            };

            var flag = true;
            var toEmailArray,ccEmailArray,bccEmailArray;
            if ($("#ToMail").val() == '') {
                alert('You cannot leave "To" field blank');
                flag = false;
            } else {
                toEmailArray = CreateCommaSeparetedArray($("#ToMail").val());
                flag = validateForm(toEmailArray,'The specified email address for "To" is invalid.','Maximum 25 emails are allowed in "To" field.');
            }
            if ($("#CcMail").val() != "" && flag == true) {
                ccEmailArray = CreateCommaSeparetedArray($("#CcMail").val());
                flag = validateForm(ccEmailArray,'The specified email address for "Cc" is invalid.','Maximum 25 emails are allowed in "Cc" field.');
            }
            if ($("#BccMail").val() != "" && flag == true) {
                bccEmailArray= CreateCommaSeparetedArray($("#BccMail").val());
                flag = validateForm(bccEmailArray,'The specified email address for "Bcc" is invalid.','Maximum 25 emails are allowed in "Bcc" field.');
            }
            if (flag == true && $("#SubjectMail").val() == "") {
                var flag = confirm("The subject field is empty. Do you wish to continue?");
            }
            if (flag) {
                //return false;
                var getUrl = '@Url.Action("SendMail", "Email", new { area = "Email" })';
                var attachmentObject = [];
                var selectedFiles = $("#tblSelectedFile tr");
                for (var i = 0; i < selectedFiles.length; i++) {
                    var tmp_name = $(selectedFiles[i]).data('tmpname');
                    var filename = $(selectedFiles[i]).data('filename');
                    attachmentObject.push({GeneratedName : tmp_name,FileName : filename});
                }
                var selectedFolder = $("#FolderStructure li.active");
                var selectedMessage = -1;
                if (selectedFolder.data("type") == "3" && isEditClickedDraft == true) {
                    var selectedMessage = $("#SelectedMessageId").val();
                }
                var toEmailString = toEmailArray.length > 0 ? toEmailArray.join(";") : "";
                var ccEmailString = ccEmailArray != undefined ? ccEmailArray.join(";") : "";
                var bccMailEmailString = bccEmailArray != undefined ? bccEmailArray.join(";") : "";
                var inboxFolder = $(".foldersList li:first");
                //var data = JSON.stringify({ "From": "", "To": toEmailString, "Cc": ccEmailString, "Bcc": bccMailEmailString, "Subject": $("#SubjectMail").val(), "Body": { "body": CKEDITOR.instances['editor'].getData() }, "Attachment": $("#uploadFile").val(), "IsSave": "false", "IsToSameAsFrom": "true","Attachments" :attachmentObject,SaveMailFolderId : inboxFolder.data('id'),eventType : 'send',selectedMessageid : selectedMessage });
                var data = JSON.stringify({ "From": "", "To": toEmailString, "Cc": ccEmailString, "Bcc": bccMailEmailString, "Subject": $("#SubjectMail").val(), "Body": { "body": CKEDITOR.instances['editor'].getData() }, "Attachment": $("#uploadFile").val(), "IsSave": "false", "IsToSameAsFrom": "true", "Attachments": attachmentObject, SaveMailFolderId: inboxFolder.data('id'), eventType: 'send', selectedMessageid: selectedMessage });
                JsonRequestData.ToEmail = toEmailString;
                JsonRequestData.CC = ccEmailString;
                JsonRequestData.Bcc = bccMailEmailString;
                JsonRequestData.Subject = $("#SubjectMail").val();
                JsonRequestData.Body = CKEDITOR.instances['editor'].getData();
                JsonRequestData.Guid = $("#guid").val();

                //$.ajax({
                //    url: getUrl,
                //    type: "POST",
                //    dataType: "json",
                //    data: data,
                //    async: true,
                //    processData: false,
                //    cache: false,
                //    contentType: 'application/json; charset=utf-8',
                //    success: function (Data) {
                //        if (Data.isSuccess == false) {
                //            alert(Data.errorMessage);
                //            return false;
                //        }

                //        if (selectedFolder.data("type") == "3" && isEditClickedDraft == true) {
                //            isEditClickedDraft  = false;
                //            $("#emailDisplay").hide();
                //            $(".selectedMessage").remove();
                //            SetDefaultMessageSelected();
                //        }
                //        $(".newEmailClose").click();
                //    }
                //});


                $.ajax({
                    url: '@Url.Action("SendMail", "EmailManage", new { area = "QueuedEmail" })',
                    type: "POST",
                    dataType: "json",
                    data: JSON.stringify(JsonRequestData),
                    async: true,
                    processData: false,
                    cache: false,
                    contentType: 'application/json; charset=utf-8',
                    success: function (Data) {

                        if (Data == "1") {
                            CKEDITOR.instances['editor'].setData('');
                            $('#emailbox').find('input:text').val('');
                            $("#tblSelectedFile").html("");
                            $(".newEmailClose").click();
                        }
                        else {
                            alert("Mail is not sent.");
                        }
                    }
                });
            }
        });

        @*$("#uploadBtn").change(function(){
            var fileInput = document.getElementById('uploadBtn');
            var formdata = new FormData(); //FormData object
            //Iterating through each files selected in fileInput
            for (i = 0; i < fileInput.files.length; i++) {
                //Appending each file to FormData object
                formdata.append(fileInput.files[i].name, fileInput.files[i]);
            }
            //Creating an XMLHttpRequest and sending
            var xhr = new XMLHttpRequest();
            //xhr.open('POST', '/Home/Upload');
            xhr.open('POST', '@Url.Action("Upload", "Email", new {area = "Email" })');
            xhr.send(formdata);
            xhr.onreadystatechange = function () {
                if (xhr.readyState == 4 && xhr.status == 200) {
                    var tmp_name = JSON.parse(xhr.response);
                    var result = "<tr class='success' data-tmpname='"+tmp_name.tmp_name+"' data-filename='"+fileInput.files[0].name+"'><td>"+fileInput.files[0].name+"</td><td><a href='#' class='close attachmentclose' data-dismiss='alert' aria-label='close'>&times;</a></td></tr>";
                    $("#tblSelectedFile").append(result);
                }
            }
            return false;
        });*@

        $("#uploadBtn").change(function(){
            var fileInput = document.getElementById('uploadBtn');
            var formdata = new FormData(); //FormData object
            //Iterating through each files selected in fileInput
            for (i = 0; i < fileInput.files.length; i++) {
                //Appending each file to FormData object
                formdata.append(fileInput.files[i].name, fileInput.files[i]);
            }
            //Creating an XMLHttpRequest and sending
            var xhr = new XMLHttpRequest();
            //xhr.open('POST', '/Home/Upload');
            xhr.open('POST', '@Url.Action("UploadFiles", "EmailManage", new {area = "QueuedEmail" })?Guid=' + $("#guid").val());
            xhr.send(formdata);
            xhr.onreadystatechange = function () {
                if (xhr.readyState == 4 && xhr.status == 200) {
                    var JsonResultOfResponse = JSON.parse(xhr.response);
                    var fileName = JsonResultOfResponse.filenameWithFullPath;
                    if (JsonResultOfResponse.status == 0) {
                        var result = "<tr class='danger' data-tmpname='" + fileName + "' data-filename='" + fileName + "'><td>" + fileName + "</td><td><a href='#' class='close attachmentclose' data-dismiss='alert' aria-label='close'>&times;</a></td></tr>";
                        $("#tblSelectedFile").append(result);
                    }
                    else if (JsonResultOfResponse.status == 1) {
                        var result = "<tr class='success' data-tmpname='" + fileName + "' data-filename='" + fileName + "'><td>" + fileName + "</td><td><a href='#' class='close attachmentclose delete-attechement' data-id=" + JsonResultOfResponse.Id +" data-dismiss='alert' aria-label='close'>&times;</a></td></tr>";
                        $("#tblSelectedFile").append(result);
                    }
                    DeleteAttechementBind();
                }
            }
            return false;
        });

        $(document).on("click", ".attachmentclose", function () {
            $(this).parent().parent().remove();
        });

        function DeleteAttechementBind() {
            $(".delete-attechement").click(function () {
                $.ajax({
                    url: '@Url.Action("DeleteAttechment", "EmailManage", new { area = "QueuedEmail" })',
                    type: "POST",
                    data: JSON.stringify({ "Id": parseInt($(this).attr("data-id")) }),
                    async: true,
                    processData: false,
                    cache: false,
                    contentType: 'application/json; charset=utf-8',
                    success: function (Data) {
                        if (Data == "1") {
                            alert("File is Remove!!");
                        }
                        else {
                            alert("File is not Remove!!");
                        }
                    },
                    error: function (data) {
                        alert("File is not Remove!!");
                    }
                });
            });
        }
        function HideToolTip(){
            $('.tooltip').hide();
        }

        function ShowToolTip(id){
            if(id==toggleId){
                $('.tooltip').show();
            }
        }

        function clickToggle(id){
            toggleId=id;
        }

        function SetParamsFromLocalStorage(){
            $("#txtName").val(localStorage.getItem('User_Name'));
            $("#txtUserName").val(localStorage.getItem('User_UserName'));
            $("#txtEmail").val(localStorage.getItem('User_Email'));
            $("#txtCompanyName").val(localStorage.getItem('User_CompanyName'));

            if(localStorage.getItem('User_IsActive') != null){
                document.getElementById("btnchkIsActive").checked = localStorage.getItem('User_IsActive')=="false" ? false: true;
            }

            $("#txtCompanyabn").val(localStorage.getItem('User_CompanyABN'));
            $("#txtMobile").val(localStorage.getItem('User_Mobile'));
            var userTypeId = localStorage.getItem('User_UserTypeId');

            getRole(userTypeId);

        }

    </script>


    <script>
        function guid() {
            return s4() + s4() + '-' + s4() + '-' + s4() + '-' +
                s4() + '-' + s4() + s4() + s4();
        }

        function s4() {
            return Math.floor((1 + Math.random()) * 0x10000)
                .toString(16)
                .substring(1);
        }
    </script>
}
