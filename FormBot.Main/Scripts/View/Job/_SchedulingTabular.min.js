function saveJobSchedule(e){var t,i,a,s,o,l,n,r,d,c,u,h=null;t=$("#visitStartDate").val(),i=$("#visitStartTime").val(),a=$("#visitEndDate").val(),s=$("#visitEndTime").val(),o=$("#RefNumber").val(),l=$("#Detail").val(),n=$("#JobID").val(),r=$("#UserId").val(),d=$("#JobSchedulingID").val(),c=$("#Status").val(),u=$("#UserId option:selected").text();var m=$("#RefNumber").val();""!=m&&null!=m&&null!=m||(m=$("#JobID option:selected").text()),jobTitle=m;var p=ConvertDateToTick(t,DateFormat);if(t=moment(p).format("YYYY-MM-DD"),null!=a&&""!=a&&null!=a&&(h=ConvertDateToTick(a,DateFormat),a=moment(h).format("YYYY-MM-DD")),!e){var v=CompareDate(t,a,i,s);if(!v&&""!=message&&null!=message&&null!=message)return $(".alert").hide(),$("#errorMsgRegionForPopUp").html(closeButton+message),$("#errorMsgRegionForPopUp").show(),!1}if("false"==$("#IsClassic").val().toString().toLowerCase()&&$("#chkListOfScheduling").find(".checklist").find("li").length<1)return alert("Please add at least one checklist item."),!1;$("#loading-image").css("display",""),SaveScheduleOnDropAndInsertEdit(t,i,a,s,o,l,r,n,d,e,c,!1,u,"",jobTitle,$("#IsClassic").val().toString().toLowerCase()),SearchHistory()}function SaveScheduleOnDropAndInsertEdit(e,t,i,a,s,o,l,n,r,d,c,u,h,m,p,v){var D="";"false"==v&&(D=$("#CheckListTemplateId").val()),$.ajaxSetup({cache:!1});var f={startDate:e,startTime:t,endDate:i,endTime:a,label:s,detail:o,userId:l,jobId:n,jobSchedulingID:r,isNotification:d,status:c,isDrop:u,userName:h,jobTitle:p,IsClassic:v,TemplateId:D};$("#alertAssignTime").data("dragData",f);var b={};if(b.JobSchedulingID=r,b.Label=s,b.Detail=o,b.strVisitStartDate=e,b.strVisitEndDate=i,b.strVisitStartTime=t,b.strVisitEndTime=a,b.JobID=n,b.UserId=l,b.Status=c,b.isNotification=d,b.isDrop=u,b.userName=h,b.JobTitle=p,b.TemplateId=D,b.IsFromCalendarView=$("#IsFromCalendarView").val(),b.SolarCompanyId=$("#hdnsolarCompanyid").val(),"false"==v||null==v){var g=[];$.each($("#chkListOfScheduling").find(".checklist").find("li"),function(){g.push($(this).data("visitchecklistitemid"))}),g.length>0&&(b.VisitCheckListItemIds=g.toString())}b.TempJobSchedulingId=$("#TempJobSchedulingId").val();var I={};I.jobSchedulingPopup=b,I.isQuickAddvisit=!1;var S=!1;return $.ajax({url:urlJobSchedulingDetail,dataType:"json",contentType:"application/json; charset=utf-8",type:"post",data:JSON.stringify(I),success:function(e){if(e){var t=e.split("^")[0],i=e.replace(t+"^","");S=ResponseSaveScheduleOnDropAndInsertEdit(e,t,i,u),u&&(S||$("#notification").modal())}""==m||null==m||null==m||($("#notification").modal("hide"),S)||m.draggable.animate(m.draggable.data().origPosition,"slow")},error:function(){message="Job Schedule has not been saved.",showErrorMessage(message),$("#notification").modal("hide"),$("#loading-image1").hide()}}),S}function FillJobSchedulingDetail(e,t){$.ajaxSetup({cache:!1}),e>0&&($("#btnJobDelete").css("display",""),$.ajax({url:urlJobSchedulingDetailById+e,contentType:"application/json",method:"get",cache:!1,success:function(e){if(e&&e.JobSchedulingID){if("true"==IsFromCalendarView_Glbl){var t=urlGetSolarElectricianForJobType+e.JobType+"&SolarCompanyId="+$("#hdnsolarCompanyid").val();FillDropDown("UserId",t,e.UserId,!0,null);var i=urlGetJobsForJobType+e.JobType+"&SolarCompanyId="+$("#hdnsolarCompanyid").val();FillDropDown("JobID",i,e.JobID,!0,null)}var a=null,s=null,o=e.strVisitStartTime.split(":",2).join(":"),l=moment(e.strVisitStartDate).format(DateFormat.toUpperCase());null!=e.strVisitEndTime&&""!=e.strVisitEndTime&&(a=e.strVisitEndTime.split(":",2).join(":")),null!=e.strVisitEndDate&&""!=e.strVisitEndDate&&(s=moment(e.strVisitEndDate).format(DateFormat.toUpperCase())),$("#visitStartDate").val(l),$("#visitStartTime").val(o),$("#visitEndDate").val(s),$("#visitEndTime").val(a),$("#RefNumber").val(e.Label),$("#Detail").val(e.Detail),$("#UserId").val(e.UserId),$("#jobScheduling").find("select[id='JobID']").val(e.JobID),$("#JobSchedulingID").val(e.JobSchedulingID),$("#Status").val(e.Status),$("#visitStartDate").datepicker("update",l),$("#visitEndDate").datepicker("update",s),$("#IsClassic").val(e.IsClassic.toString().toLowerCase()),$("#JobType").val(e.JobType);var n=ConvertDateToTick($("#visitStartDate").val(),DateFormat);$("#visitEndDate").data("datepicker").setStartDate(new Date(n)),ResponseShowJobSchedulingDetail(e),$("#popUpJobDetail").modal(),$("#popUpJobDetail").find("input[type=text]").each(function(){$(this).attr("class","form-control valid")}),$("#popUpJobDetail").find("Select").each(function(){$(this).attr("class","form-control valid")}),"false"==IsFromCalendarView_Glbl&&$("#jobScheduling").find("select[id='JobID']").attr("disabled","disabled"),"false"==e.IsClassic.toString().toLowerCase()?($("#loading-image").show(),e.CheckListTemplateId>0?OpenCheckListItemPopup(e.CheckListTemplateEncodedId):OpenCheckListItemPopup(e.DefaultTemplateId)):$("#checkListTemplateForm").empty(),$("#popUpJobDetail").find(".field-validation-error").attr("class","field-validation-valid")}else message="Job Schedule has not been opened.",showErrorMessageCalendar(message)},error:function(){message="Job Schedule has not been opened.",showErrorMessageCalendar(message)}}))}function CompareDate(e,t,i,a){var s=function(e){return moment(e).minutes()+60*moment(e).hours()};return Date.parse(e)>Date.parse(t)?(message="Start date should not be greater than end date",!1):e!=t||(s(e+" "+i)>s(t+" "+a)?(message="Start time must be less than end Time",!1):s(e+" "+i)!=s(t+" "+a)||(message="Start time and end time should not be same time",!1))}function DeleteJobSchedulingDetail(e,t){confirm("Are you sure you want to delete this job schedule?")&&($("#loading-image").css("display",""),setTimeout(function(){DeleteJSD(e,t),SearchHistory()},500))}function DeleteJSD(e,t){null==e&&(e=$("#JobSchedulingID").val()),null==t&&(t=$("#UserId").val()),$.ajax({url:urlDeleteJobSchedule+e+"&userId="+t+"&jobTitle="+$("#JobTitle").val(),contentType:"application/json",method:"post",success:function(t){ResponseDelete(t.jobSchedulingId,e),t.installerDesignerId==(1==BasicDetails_JobType?parseInt($("#hdBasicDetails_InstallerID").val()):parseInt($("#hdBasicDetails_SWHInstallerID").val()))&&(ShowHideVisitScheduledIcon(!0,!1,t.seStatus),$("#btnInstallerQuickVisit").attr("onClick",BasicDetails_JobType='addQuickVisit($("#hdBasicDetails_InstallerID").val(), $("#txtBasicDetails_InstallerID").val(),'+t.seStatus+");"))},error:function(){message="Job schedule has not been deleted.",showErrorMessage(message)}})}function OpenCheckListItemPopup(e,t){CommonOpenCheckListItemPopup(e,!1,$("#JobSchedulingID").val(),t)}function CommonOpenCheckListItemPopup(e,t,i,a,s,o,l,n,r){a=!!a;var d="";"false"==t&&visitCheckListItemIds.length>0&&(d=visitCheckListItemIds.join(","));var c="/CheckListItem/GetCheckListItemByTemplateId?id="+e+"&isSetFromSetting="+t+"&jobSchedulingId="+i+"&isTemplateChange="+isVisitCheckListTemplateChange+"&tempJobSchedulingId="+s+"&jobId="+$("#JobID").val()+"&visitCheckListIdsString="+d+"&isAddVisit="+l+"&JobType="+n+"&SolarCompanyId="+$("#hdnsolarCompanyid").val()+"&isFromIsDeletedChecklistItem="+r;$.get(c,function(i){$("#checkListTemplateForm").empty(),$("#checkListTemplateForm").append(i),1==t&&$("#popupCheckListTemplate").modal({backdrop:"static",keyboard:!1}),""==e&&$(".liAddCheckListItem").hide(),"false"==t.toString()&&(visitCheckListItemIds=[],$.each($("#chkListOfScheduling").find(".checklist").find("li"),function(){visitCheckListItemIds.push($(this).data("visitchecklistitemid"))})),$("#loading-image").hide()})}function SearchHistory(){var e=$("#historyCategory").val();e=null!=e?e:0;var t=!1,i=$("#filter-postvisibility").val(),a=$("#BasicDetails_JobID").val(),s=$("#IsDeletedJobNote").val(),o="DESC";$("#loading-image").show(),setTimeout(function(){$.ajax({url:showhistoryUrl,type:"GET",data:{jobId:a,categoryID:e,order:o,PostVisibility:i,IsImportant:t,IsDeletedJobNote:s},cache:!1,async:!1,success:function(e){window.onbeforeunload=null,$("#showfilteredhistory").html($.parseHTML(e)),$("divCustom").mCustomScrollbar()}}),AddHistoryIcons(),tagandsearchfilter(),hideEditDeleteIcons(),$("#loading-image").hide()},10)}function AddHistoryIcons(){$(".history-block li").each(function(){var e=$(this).attr("class");void 0!==e&&(e.includes("stage-status")?$(this).find(".border-icon").addClass("fa-regular fa-building"):e.includes("notes-status")?$(this).find(".border-icon").addClass("fa-regular fa-note-sticky"):e.includes("message-status")?$(this).find(".border-icon").addClass("message1"):e.includes("traded-status")?$(this).find(".border-icon").addClass("fa-regular fa-circle-dollar-to-slot"):e.includes("stc-status")?$(this).find(".border-icon").addClass("fa-solid fa-pen-to-square"):e.includes("scheduling-status")?$(this).find(".border-icon").addClass("fa-solid fa-briefcase"):e.includes("documents-status")?$(this).find(".border-icon").addClass("fa-regular fa-file-lines"):e.includes("signature-status")?$(this).find(".border-icon").addClass("fa-regular fa-file-signature"):e.includes("spvlogs-status")?$(this).find(".border-icon").addClass("fa-regular fa-clipboard-check"):e.includes("invoice-status")&&$(this).find(".border-icon").addClass("fa-regular fa-file-invoice-dollar"))})}function tagandsearchfilter(){var e=0,t=$("#relatedTofilter").val(),i="@"+t,a=$("#JobHistorySearch").val();if("0"==t?$("#divCustom .history-box").each(function(){$(this).text().search(new RegExp(a,"i"))<0?$(this).hide():($(this).show(),$("#norecords").empty(),e++)}):$("#divCustom .history-box").each(function(){$(this).text().search(new RegExp(i,"i"))<0||$(this).text().search(new RegExp(a,"i"))<0?$(this).hide():($(this).show(),$("#norecords").empty(),e++)}),e>0)$(".history-box").css("border-top","1px solid #e3e3e3");else{$("#norecords").empty();var s="<div style='text-align:center;font-size:24px;margin-top:120px'>No Record(s) Found.</div>";$("#norecords").append(s)}}function hideEditDeleteIcons(){$(".IconsEditDelete").each(function(){$(this).css("display","none !important")})}function callbackCheckList(){$("#checkListItemForTrade").find("ul").find("li").length>0?$("#checkListItemForTrade").show():$("#checkListItemForTrade").hide()}$(document).ready(function(){$("#btnAddVisit").click(function(e){addVisit()}),$("#visitStartDate").datepicker({format:FormBot_HelperDateFormat,autoclose:!0}).on("changeDate",function(){if(""!=$("#visitEndDate").val()){var e=new Date(ConvertDateToTick($("#visitStartDate").val(),FormBot_HelperDateFormat)),t=new Date(ConvertDateToTick($("#visitEndDate").val(),FormBot_HelperDateFormat));e>t&&$("#visitEndDate").val("")}var i=ConvertDateToTick($("#visitStartDate").val(),FormBot_HelperDateFormat);tDate=moment(i).format("MM-DD-YYYY"),$("#visitEndDate").data("datepicker")&&$("#visitEndDate").data("datepicker").setStartDate(new Date(tDate))}).on("change",function(){$(this).valid()}),$("#visitEndDate").datepicker({format:FormBot_HelperDateFormat,autoclose:!0}).on("change",function(){$(this).valid()}),$("#visitStartTime, #visitEndTime").datetimepicker({format:"HH:mm"}),$("#visitStartDate").keydown(function(e){return 9==e.which}),$("#visitEndDate").keydown(function(e){return 9==e.which}),$("#visitStartTime").keydown(function(e){return 9==e.which}),$("#visitEndTime").keydown(function(e){return 9==e.which}),$("#noNotification").click(function(){$("#notification").modal("hide"),$("#popUpJobDetail").modal("hide")}),$("#yesNotification").click(function(){if($("#alertAssignTime").data("dragData")){var e=$("#alertAssignTime").data("dragData");SaveScheduleOnDropAndInsertEdit(e.startDate,e.startTime,e.endDate,e.endTime,e.label,e.detail,e.userId,e.jobId,e.jobSchedulingID,!0,e.status,e.isDrop,"","",e.jobTitle,e.IsClassic.toString().toLowerCase())}"true"==$("#yesNotification").attr("isAutoScheduleVisit")&&addQuickVisit(1==$("#BasicDetails_JobType").val()?$("#hdBasicDetails_InstallerID").val():$("#hdBasicDetails_SWHInstallerID").val(),1==$("#BasicDetails_JobType").val()?$("#txtBasicDetails_InstallerID").val():$("#txtBasicDetails_SWHInstallerID").val(),2,"",!0)}),$("#saveJobSchedule").click(function(){$("#jobScheduling").valid()&&saveJobSchedule(!1)})});