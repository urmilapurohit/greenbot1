function CheckForChangeSCA(){$.ajax({type:"get",url:urlGetSTCBasicDetails,dataType:"json",data:{jobID:jobID},async:!1,success:function(e){"not yet submitted"!=e.stcStatus&&"submit to trade"!=e.stcStatus||!isChangeSCA?$("#divIsChangeSCA").html(""):$("#divIsChangeSCA").html('<input type="button" class="primary" value="Change SCA" onclick="changeSCAModal()" style="margin-left: 5px"/>')},error:function(e){alert("Error occured...")}})}function BindDeemingPeriodDropdown(e,a){$.ajax({type:"get",url:urlGetDeemingPeriod,dataType:"json",data:{year:e},async:!1,success:function(e){$("#JobSTCDetails_DeemingPeriod").html(""),$.each(e,function(e,a){$("#JobSTCDetails_DeemingPeriod").append('<option value="'+a.Value+'">'+a.Text+"</option>")}),0!=a?document.getElementById("JobSTCDetails_DeemingPeriod").value=a:$("#JobSTCDetails_DeemingPeriod").val($("#JobSTCDetails_DeemingPeriod option:last").val())},error:function(e){alert("Failed to retrieve DeemingPeriod."+e)}})}function BindSTCJobStagesTabular(){return $("#STCJobStage_Tabular").empty(),$.ajax({type:"POST",url:urlGetSTCJobStages,dataType:"json",async:!1,success:function(e){$("#STCJobStage_Tabular").append('<option value="0">Select STC job stage</option>'),$.each(e,function(e,a){$("#STCJobStage_Tabular").append('<option value="'+a.Value+'">'+a.Text+"</option>")}),$("#STCJobStage_Tabular").val($("#STCJobStageId").val())},error:function(e){alert("Failed to retrieve Job Stages."+e)}}),!1}function BindBasicDetailsValue(){function e(){BasicDetails_SSCID>0&&1!=ProjectSession_UserTypeId&&3!=ProjectSession_UserTypeId&&4!=ProjectSession_UserTypeId&&5!=ProjectSession_UserTypeId&&2!=ProjectSession_UserTypeId?$("#SSCID").prop("disabled",!0):$("#SSCID").prop("disabled",!1)}BindSTCJobStagesTabular(),dropDownData.push({id:"BasicDetails_JobStage",key:"JobStage",value:BasicDetails_JobStage,hasSelect:!0,callback:null,defaultText:null,proc:"Job_GetJobSatge",param:[],bText:"StageName",bValue:"JobStageId"}),dropDownData.push({id:"BasicDetails_Priority",key:"",value:BasicDetails_Priority,hasSelect:!0,callback:null,defaultText:null,proc:"GetPriority",param:[],bText:"Text",bValue:"Value"}),0!=BasicDetails_ScoID&&BasicDetails_ScoID>0?dropDownData.push({id:"ScoID",key:"",value:BasicDetails_ScoID,hasSelect:!0,callback:null,defaultText:null,proc:"User_GetSCOUser",param:[{JobID:Model_JobID}],bText:"Name",bValue:"UserId"}):dropDownData.push({id:"ScoID",key:"",value:null,hasSelect:!0,callback:null,defaultText:null,proc:"User_GetSCOUser",param:[{JobID:Model_JobID}],bText:"Name",bValue:"UserId"}),dropDownData.push({id:"SSCID",key:"",value:BasicDetails_SSCID,hasSelect:!0,callback:e,defaultText:null,proc:"User_GetSSCUserByJbID",param:[{JobID:Model_JobID}],bText:"Name",bValue:"UserId"}),dropDownData.bindDropdown(),dropDownData.bindDropdown(),DisplayInstallationDate()}function DisplayInstallationDate(){var e=$("#BasicDetails_strInstallationDate").val();if(null!=e&&null!=e&&""!=e){$("#BasicDetails_strInstallationDate").val("").removeAttr("value");var a=moment(e).format(dateFormat.toUpperCase());$("#BasicDetails_strInstallationDate").val(a),$("#BasicDetails_strInstallationDate").attr("data-date-format","dd/mm/yyyy"),$(".date-pick, .date-pick1, .date-pick").datepicker({format:dateFormat,autoclose:!0}).on("changeDate",function(){$(this).datepicker("hide")})}else $(".date-pick, .date-pick1, .date-pick").datepicker({format:dateFormat,autoclose:!0}).on("changeDate",function(){$(this).datepicker("hide")})}function DisplaySoldByDate(){var e=$("#BasicDetails_strSoldByDate").val();if(null!=e&&null!=e&&""!=e){$("#BasicDetails_strSoldByDate").val("").removeAttr("value");var a=moment(e).format(dateFormat.toUpperCase());$("#BasicDetails_strSoldByDate").val(a),$("#BasicDetails_strSoldByDate").attr("data-date-format","dd/mm/yyyy"),$("#BasicDetails_strSoldByDate").datepicker({format:dateFormat,autoclose:!0}).on("changeDate",function(){$(this).datepicker("hide")})}else $("#BasicDetails_strSoldByDate").datepicker({format:dateFormat,autoclose:!0}).on("changeDate",function(){$(this).datepicker("hide")});jsonvarSoldByDate=$("#BasicDetails_strSoldByDate").val(),jsonvarJobSoldBy=$("#BasicDetails_SoldBy").val()}function BindDocumentsTab(){var e=$("#hdnjobId_tblr").val();$.ajax({url:"/Job/GetDocumentsTab",data:{JobId:e},type:"post",contenttype:"application/json; charset=utf-8",async:!0,success:function(e){isDocumentsPhotos=!0,$(".tab8").html(e)},error:function(e){alert("error")}})}function BindPartialView(e,a){var t=!1,s=$("#hdnjobId_tblr").val(),o=$("#hdnId_tblr").val();"Installation Details"==e&&1==isInstallationDetails&&(t=!0),"Custom Details"==e&&1==isCustomDetails&&(t=!0),"STC Details"==e&&1==isSTCDetails&&(t=!0),"STC Status"==e&&1==isSTCStatus&&(t=!0),"System Details"==e&&1==isSystemDetails&&(t=!0),"Installer Details"==e&&1==isInstallerDetails&&(t=!0),"Scheduling"==e&&1==isScheduling&&(t=!0),"DocumentsPhotos"==e&&1==isDocumentsPhotos&&(t=!0),"NotesHistory"==e&&1==isNotesHistory&&(t=!0),"WrittenStatementsDeclaration"==e&&1==isWrittenStatementsDeclaration&&(t=!0),"RetailerDetails"==e&&1==isRetailerDetails&&(t=!0),t||$.ajax({url:"/Job/GetResultByAjax",data:{Flag:e,DATAOPMODE:a,JobId:s,ID:o},type:"post",contenttype:"application/json; charset=utf-8",async:!0,success:function(a){"Owner Details"==e?($(".tab1").html(a),isOwnerDetailsFetch=!0):"Installation Details"==e?($(".tab5").html(a),isInstallationDetails=!0):"Custom Details"==e?($(".tab15").html(a),isCustomDetails=!0):"STC Details"==e?($(".tab4").html(a),isSTCDetails=!0,SessionPanelXml.length>0&&(PanelXml=SessionPanelXml),SessionInvertorXml.length>0&&(InverterXml=SessionInvertorXml),SessionBatteryXml.length>0&&(batteryXml=SessionBatteryXml)):"STC Status"==e?($(".tab12").html(a),isSTCStatus=!0):"System Details"==e?($(".tab2").html(a),SessionPanelXml=PanelXml,SessionInvertorXml=InverterXml,SessionBatteryXml=batteryXml,isSystemDetails=!0,isInstallationDetails||(BindPartialView("Installation Details",3),isInstallationDetails=!0),isSTCDetails||(BindPartialView("STC Details",4),isSTCDetails=!0)):"Installer Details"==e?($(".tab3").html(a),isInstallerDetails=!0):"Scheduling"==e?($(".tab7").html(a),isScheduling=!0):"DocumentsPhotos"==e?($(".tab8").html(a),isDocumentsPhotos=!0,isSerialnumberDetails=!0):"NotesHistory"==e?($(".tab9").html(a),isNotesHistory=!0):"WrittenStatementsDeclaration"==e?($(".tab10").html(a),isWrittenStatementsDeclaration=!0):"RetailerDetails"==e?($(".tab11").html(a),isRetailerDetails=!0):"PreApproval"==e?($(".tab14").html(a),isPreApproval=!0):"Connection"==e&&($(".tab13").html(a),isConnections=!0)},error:function(e){alert("error")}})}function SavePreapprovalConnectionComment(e){var a=0,t="",s="";1==$("#preApprovalConnectionVal").val()?(a=$("#JobStatusForPreApproval").val(),t=$("#JobStatusForPreApproval option:selected").text()):(a=$("#JobStatusForConnection").val(),t=$("#JobStatusForConnection option:selected").text()),s=1==e?($("#preApprovalConnectionVal").val(),t):1==$("#preApprovalConnectionVal").val()?$("#txtPreapprovalComment").val():$("#txtConnComment").html();var o=JSON.stringify({JobId:$("#BasicDetails_JobID").val(),JobStatusId:a,PreApprovalAndConnectionId:$("#preApprovalConnectionVal").val(),Comment:s,ModifiedBy:ProjectSession_LoggedInUserId,Status:t});$.ajax({url:AddUpdateJobCommentForPreApprAndConnURL,type:"POST",dataType:"json",data:o,contentType:"application/json; charset=utf-8",success:function(a){a?1==$("#preApprovalConnectionVal").val()?1==e?(showSuccessMessage("Preapproval status has been changed successfully."),$("#spanPreapprovalComment").text(t),$("#txtPreapprovalComment").val(t)):($("#spanPreapprovalComment").text($("#txtPreapprovalComment").val()),showSuccessMessage("Preapproval comment has been saved successfully."),$("#popupboxPreapprovalConnectionComment").modal("hide")):1==e?(showSuccessMessage("Connection status has been changed successfully."),$("#spanConnectionComment").text(t),$("#txtConnComment").val(t)):($("#spanConnectionComment").text($("#txtConnComment").val()),showSuccessMessage("Connection comment has been saved successfully."),$("#popupboxPreapprovalConnectionComment").modal("hide")):1==$("#preApprovalConnectionVal").val()?showErrorMessage(1==e?"Preapproval status has not been changed.":"Preapproval comment has not been saved."):showErrorMessage(1==e?"Connection status has not been changed.":"Connection comment has not been saved.")}})}function validTabularPage(){if($("#frmBasicDetail").valid()){$("#JobOwnerDetails_JobID").val(BasicDetails_JobID);var e=JobInstallationDetails_PropertyType,a=$("#JobOwnerDetails_Email").val();if("commercial"==e.toLowerCase()&&(null==a||""==a))return showErrorMessage("Owner email address is mandatory for commercial jobs."),isValidTabularData=!1,!1;if("school"==e.toLowerCase()&&(null==a||""==a))return showErrorMessage("Owner email address is mandatory for installation property type school."),isValidTabularData=!1,!1;if(isSTCDetails){e=$("#JobInstallationDetails_PropertyType").val(),a=$("#JobOwnerDetails_Email").val();var t=$("#JobSTCDetails_Latitude").val(),s=$("#JobSTCDetails_Longitude").val(),o=/^[-+]?[0-9]+\.[0-9]+$/;if(""!=t&&!t.match(o))return showErrorMessage("Please enter latitude in decimal format of STC job details."),isValidTabularData=!1,!1;if(""!=s&&!s.match(o))return showErrorMessage("Please enter longitude in decimal format of STC job details."),isValidTabularData=!1,!1;if("commercial"==e.toLowerCase()&&(null==a||""==a))return showErrorMessage("Owner email address is mandatory for commercial jobs."),isValidTabularData=!1,!1;if("school"==e.toLowerCase()&&(null==a||""==a))return showErrorMessage("Owner email address is mandatory for installtion property type school."),isValidTabularData=!1,!1}if(isInstallationDetails){var i=$("#txtAddress1").val();if(""==i.trim()||null==i||null==i)return $("#spantxtAddress").show(),isValidTabularData=!1,!1;$("#spantxtAddress").hide();var l=addressValidationRules("JobInstallationDetails");if(!l)return!1}if(isCustomDetails&&!$("#frmCustomDetails").valid())return!1;if(isSystemDetails){var r;r=1==$("#BasicDetails_JobType").val()?!!($("#BasicDetails_strInstallationDate").val()&&$("#JobSTCDetails_DeemingPeriod").val()&&$("#JobInstallationDetails_PostCode").val()):!!(systemXml.length>0&&systemXml[0].Brand&&systemXml[0].Model&&$("#JobInstallationDetails_PostCode").val());var n,d=$("#JobSystemDetails_SystemSize").val()>0,c=!!$("#BasicDetails_strInstallationDate").val();if(n=1==$("#BasicDetails_JobType").val()?!d||d&&r:!c||c&&r,!n)return!1}if(isSerialnumberDetails||isDocumentsPhotos){var u=!1,b=!1;if(DuplicateSerialandInverterErrorMsg="","false"==isPanelSerialNumber.toLowerCase()&&8==ProjectSession_UserTypeId)u=!0;else if(u=DuplicateSerialNumbersValidation($("#JobSystemDetails_SerialNumbers"),$("#spanSerialNumbers"),!0),b=DuplicateSerialNumbersValidation($("#JobSystemDetails_InverterSerialNumbers"),$("#spanInverterSerialNumbers"),!1),!u||!b)return!1}return!0}}function CommonTabularDataForSave(){var e=JSON.stringify($("form").serializeToJson()),a=JSON.parse(e);a.isOverRideSave=isOverRideSave,$("#JobOwnerDetails_JobID").val(BasicDetails_JobID);var t=JobInstallationDetails_PropertyType,s=$("#JobOwnerDetails_Email").val();if("commercial"==t.toLowerCase()&&(null==s||""==s))return showErrorMessage("Owner email address is mandatory for commercial jobs."),!1;if("school"==t.toLowerCase()&&(null==s||""==s))return showErrorMessage("Owner email address is mandatory for installation property type school."),!1;isGST=!1,null!=$("#BasicDetails_IsGst").val()&&""!=$("#BasicDetails_IsGst").val()&&(isGST=$("#BasicDetails_IsGst").val());var o=JSON.stringify($("#frmBasicDetail").serializeToJson().JobOwnerDetails);if(a.JobOwnerDetails=JSON.parse(o),a.JobOwnerDetails.isGST=isGST,1==isSTCDetails){t=$("#JobInstallationDetails_PropertyType").val(),s=$("#JobOwnerDetails_Email").val();var i=$("#JobSTCDetails_Latitude").val(),l=$("#JobSTCDetails_Longitude").val(),r=/^[-+]?[0-9]+\.[0-9]+$/;if(""!=i&&!i.match(r))return showErrorMessage("Please enter latitude in decimal format of STC job details."),!1;if(""!=l&&!l.match(r))return showErrorMessage("Please enter longitude in decimal format of STC job details."),!1;if("commercial"==t.toLowerCase()&&(null==s||""==s))return showErrorMessage("Owner email address is mandatory for commercial jobs."),!1;if("school"==t.toLowerCase()&&(null==s||""==s))return showErrorMessage("Owner email address is mandatory for installtion property type school."),!1;var n=JSON.stringify($("#frmStcDetail").serializeToJson());a.JobSTCDetails=JSON.parse(n).JobSTCDetails,a.JobSTCDetails.JobType=$("#BasicDetails_JobType").val()}if(1==isInstallationDetails){if($("#JobInstallationDetails_IsSameAsOwnerAddress").is(":checked"))var d=$("#txtAddress1").val();else d=$("#txtAddress").val();if(""==d.trim()||null==d||null==d)return $("#spantxtAddress").show(),!1;$("#spantxtAddress").hide();addressValidationRules("JobInstallationDetails");$("#JobInstallationDetails_JobID").val(BasicDetails_JobID);var c=[];$("#customDetails").find(".spanCustomFields").each(function(){c.push({JobCustomFieldId:$(this).attr("data-jobcustomfieldid"),FieldValue:$(this).val(),SeparatorId:$(this).attr("data-SeperatorId")})});var u=JSON.stringify($("#JobInstallationAddress").serializeToJson()),b=JSON.parse(u),m=JSON.stringify($("#frmInstallationDetail").serializeToJson());a.JobInstallationDetails=JSON.parse(m).JobInstallationDetails,$.extend(a.JobInstallationDetails,b.JobInstallationDetails),a.JobInstallationDetails.lstCustomDetails=c;for(var S=$("#customDetails").find(".spanCustomFields").length,p=0;p<S;p++)delete a["lstCustomDetails["+p+"]"]}if(1==isSystemDetails){var D="",v="",h=[];if(h=JSON.parse(JSON.stringify(batteryXml)),PanelXml.length>0){var f=JSON.stringify(PanelXml),y="",g=$.parseJSON(f);$.each(g,function(){y+="<panel><Brand>"+htmlEncode(this.Brand)+"</Brand><Model>"+htmlEncode(this.Model)+"</Model><NoOfPanel>"+this.Count+"</NoOfPanel><Supplier>"+htmlEncode(this.Supplier)+"</Supplier></panel>"}),D="<Panels>"+y+"</Panels>"}if(InverterXml.length>0){f=JSON.stringify(InverterXml),y="",g=$.parseJSON(f);$.each(g,function(){y+="<inverter><Brand>"+htmlEncode(this.Brand)+"</Brand><Model>"+htmlEncode(this.Model)+"</Model><Series>"+htmlEncode(this.Series)+"</Series><NoOfInverter>"+htmlEncode(this.NoOfInverter)+"</NoOfInverter><Supplier>"+htmlEncode(this.Supplier)+"</Supplier></inverter>"}),v="<Inverters>"+y+"</Inverters>"}$("#panelXml").val(D),$("#inverterXml").val(v),$("#JobSystemDetails_jobTypeTab").val(jobType),$("#JobSystemDetails_JobID").val(BasicDetails_JobID),$("#OldPanelDetails").val(JSON.stringify(OldPanelXml)),$("#NewPanelDetails").val(JSON.stringify(PanelXml));var T=JSON.stringify($("#frmSystemDetail").serializeToJson());a.JobSystemDetails=JSON.parse(T).JobSystemDetails;var I,C=JSON.parse(T).JobSystemDetails;if(C.ModifiedCalculatedSTC=1==$("#BasicDetails_JobType").val()?$("#JobSystemDetails_CalculatedSTC").val():$("#JobSystemDetails_CalculatedSTCForSWH").val(),C.NoOfPanel=$("#JobSystemDetails_NoOfPanel").html(),C.InstallationType=$("#JobSystemDetails_InstallationType").val(),systemXml.length>0&&(C.SystemBrand=systemXml[0].Brand,C.SystemModel=systemXml[0].Model),C.panelXmlTabular=D,C.inverterXmlTabular=v,C.SerialNumbers=$("#JobSystemDetails_SerialNumbers").val(),C.InverterSerialNumbers=$("#JobSystemDetails_InverterSerialNumbers").val(),h.length>0){for(p=0;p<h.length;p++)delete h[p].JobBatteryManufacturerId;C.lstJobBatteryManufacturer=h,"select"==$("#JobSTCDetails_batterySystemPartOfAnAggregatedControl").val().toLowerCase()?C.batterySystemPartOfAnAggregatedControl="":C.batterySystemPartOfAnAggregatedControl=$("#JobSTCDetails_batterySystemPartOfAnAggregatedControl").val(),"select"==$("#JobSTCDetails_changedSettingOfBatteryStorageSystem").val().toLowerCase()?C.changedSettingOfBatteryStorageSystem="":C.changedSettingOfBatteryStorageSystem=$("#JobSTCDetails_changedSettingOfBatteryStorageSystem").val()}I=1==$("#BasicDetails_JobType").val()?!!($("#BasicDetails_strInstallationDate").val()&&$("#JobSTCDetails_DeemingPeriod").val()&&$("#JobInstallationDetails_PostCode").val()):!!(systemXml.length>0&&systemXml[0].Brand&&systemXml[0].Model&&$("#JobInstallationDetails_PostCode").val());var J=$("#JobSystemDetails_SystemSize").val()>0,w=!!$("#BasicDetails_strInstallationDate").val();1==$("#BasicDetails_JobType").val()?!J||J&&I:!w||w&&I,a.objSystem=C,a.OldPanelDetails=$("#OldPanelDetails").val(),a.NewPanelDetails=$("#NewPanelDetails").val(),"false"==isPanelSerialNumber.toLowerCase()&&8==ProjectSession_UserTypeId||SerialNumbersValidation()}if(1==isDocumentsPhotos){$("#JobSystemDetails_JobID").val(BasicDetails_JobID);C={SerialNumbers:$("#JobSystemDetails_SerialNumbers").val(),InverterSerialNumbers:$("#JobSystemDetails_InverterSerialNumbers").val()};"false"==isPanelSerialNumber.toLowerCase()&&8==ProjectSession_UserTypeId||SerialNumbersValidation()}var _=JSON.stringify(a);return _}function getDataTabular(e,a,t){$.ajax({type:"POST",dataType:"json",contentType:"application/json; charset=utf-8",url:e,data:JSON.stringify(a),success:function(e){e.status?t&&t(e):showErrorMessage(e.error)},error:function(e){showErrorMessage("job has not been saved."+e)}})}function checkBusinessRules(e){""!=$("#SSCID").val()&&$("#SSCID").val()>0&&$("#BasicDetails_SSCID").val($("#SSCID").val()),""!=$("#ScoID").val()&&$("#ScoID").val()>0&&$("#BasicDetails_ScoID").val($("#ScoID").val());var a=CommonTabularDataForSave();$.ajax({url:urlCheckBusinessRulesTabular,type:"POST",dataType:"json",contentType:"application/json; charset=utf-8",processData:!1,data:a,cache:!1,success:function(a){a.IsSuccess?(0==a.isIsValidSystemSize?($("#JobSystemDetails_SystemSize").css("border-color","red"),$("#OldSystemSize").css("border-color","red")):($("#JobSystemDetails_SystemSize").css("border-color",""),$("#OldSystemSize").css("border-color","")),null!=a.ValidationSummary&&null!=a.ValidationSummary&&""!=a.ValidationSummary&&(e?1!=ProjectSession_UserTypeId&&($(".STCmodelBodyMessage").html(""),$(".STCmodelBodyMessage").append(a.ValidationSummary),$("#STCwarning").modal({backdrop:"static",keyboard:!1}),"true"==a.IsEMailNotification.toString().toLowerCase()&&$.ajax({url:urlSendMailForDuplicateAddress,method:"GET",data:{jobid:$("#BasicDetails_JobID").val(),mailList:a.EMailList.trim().toString().toLowerCase()},cache:!1,async:!0,success:function(e){}})):($(".modelBodyMessage").html(""),$(".modelBodyMessage").append(a.ValidationSummary),$("#warning").modal()))):a.IsError&&showErrorMessage(a.ValidationSummary)}})}function showErrorMessage(e){$(".alert").hide(),$("#successMsgRegion").hide(),$("#errorMsgRegion").html(closeButton+e),$("#errorMsgRegion").show(),$("html").animate({scrollTop:0},"slow"),$("body").animate({scrollTop:0},"slow")}function ReloadSTCModule(){$("#loading-image").show(),setTimeout(function(){$.get(urlGetSTCJobForTabular+BasicDetails_JobID,function(e){$("#reloadSTCJobScreen").empty(),$("#reloadSTCJobScreen").append(e),10!=$("#STCStatusId").val()&&12!=$("#STCStatusId").val()&&14!=$("#STCStatusId").val()&&17!=$("#STCStatusId").val()&&($("#CESDocbtns").hide(),$("#STCDocBtns").hide(),$(".isdelete").css("display","none")),1!=ProjectSession_UserTypeId&&3!=ProjectSession_UserTypeId&&4!=ProjectSession_UserTypeId&&2!=ProjectSession_UserTypeId&&5!=ProjectSession_UserTypeId||($("#CESDocbtns").show(),$("#STCDocBtns").show()),1!=ProjectSession_UserTypeId&&3!=ProjectSession_UserTypeId||$(".isdelete").css("display","block"),1!=ProjectSession_UserTypeId&&3!=ProjectSession_UserTypeId&&10!=$("#STCStatusId").val()&&12!=$("#STCStatusId").val()&&14!=$("#STCStatusId").val()&&17!=$("#STCStatusId").val()&&$("#btnsave").hide(),$("#loading-image").hide()})},500)}function showSuccessMessage(e){$(".alert").hide(),$("#errorMsgRegion").hide(),$("#successMsgRegion").html(closeButton+e),$("#successMsgRegion").show(),$("html").animate({scrollTop:0},"slow"),$("body").animate({scrollTop:0},"slow")}function ShowHideGSTSection(e,a){2==tempIsRegisteredWithGST&&"true"==modelIsRegisteredWithGST?($(".isGSTRegistered").show(),$("#jobGST").show(),$("#BasicDetails_IsGst").val(!0)):1==tempIsRegisteredWithGST&&"true"==modelIsRegisteredWithGST?"corporate body"==a||"trustee"==a?null!=modelIsOwnerRegisteredWithGST&&"true"==modelIsOwnerRegisteredWithGST.toString().toLowerCase()?($(".isGSTRegistered").show(),$("#jobGST").show(),$("#BasicDetails_IsGst").val(!0)):($(".isGSTRegistered").hide(),$("#BasicDetails_IsGst").val(!1)):"commercial"==e||"school"==e?($(".isGSTRegistered").show(),$("#jobGST").show(),$("#BasicDetails_IsGst").val(!0)):($(".isGSTRegistered").hide(),$("#BasicDetails_IsGst").val(!1)):($(".isGSTRegistered").hide(),$("#BasicDetails_IsGst").val(!1),$("#BasicDetails_IsGst").val(!1))}function loadInvoice(){if(isParentInvoice=!1,$("#datatable")){var e=$("#datatable").DataTable();e.destroy()}$("#datatable").DataTable({iDisplayLength:10,lengthMenu:ProjectConfiguration_GetPageSize,order:[[1,"asc"]],language:{sLengthMenu:"Page Size: _MENU_"},columns:[{data:"JobInvoiceID",orderable:!1,render:function(e,a,t,s){return LogInID==t.CreatedBy?'<a href="javascript:void(0)" class="action view" style="background:url(../../Images/ic-outgoing.png) no-repeat center;cursor:default; text-decoration:none;margin-left:-30%;"></a>':'<a href="javascript:void(0)" class="action view" style="background:url(../../Images/ic-incoming.png) no-repeat center;cursor:default; text-decoration:none;margin-left:-30%;"></a>'}},{data:"InvoiceNumber",orderable:!0},{data:"CreatedDate",render:function(e){return ConvertToDateWithFormat(e,ProjectConfiguration_GetDateFormat)}},{data:"Created"},{data:"InvoicedTo"},{data:"FileName",render:function(e,a,t,s){return 1==t.Status?"<p style='color:green;'>"+t.FileName+"</p>":2==t.Status?"<p style='color:gray;'>"+t.FileName+"</p>":3==t.Status?"<p style='color:orange;'>"+t.FileName+"</p>":4==t.Status?"<p style='color:red;'>"+t.FileName+"</p>":"<p style='color:red;'></p>"},orderable:!1},{data:"InvoiceTotal",orderable:!0,sClass:"dt-right",render:function(e,a,t,s){return PrintDecimal(t.InvoiceTotal)}},{data:"InvoiceAmountDue",orderable:!0,sClass:"dt-right",render:function(e,a,t,s){return PrintDecimal(t.InvoiceAmountDue)}},{data:"JobInvoiceID",render:function(e,a,t,s){var o="";"1"==t.FileExist?o='<a class="action view" href="javascript:void(0)" style="background:url(../../Images/pdf.png) no-repeat center; text-decoration:none;margin-left:18px;" onclick="DownloadReport(this)" filename="'+t.InvoiceNumber+'.pdf"></a>':"0"==t.FileExist&&(o='<a class="action view" style="background:none;text-decoration:none;margin-left:18px;"></a>');var i="";i=1==t.Sent?'<a href="javascript:void(0)" class="action view" style="background:url(../../Images/ic-right.png) no-repeat center; cursor:default;text-decoration:none;margin-left:18px;"></a>':'<a href="javascript:void(0)" class="action view" style="background:url(../../Images/ic-wrong.png) no-repeat center; cursor:default;text-decoration:none;margin-left:18px;"></a>';var l='&nbsp;<a href="javascript:void(0);" class="action view" style="background:url(../../Images/edit-icon.png) no-repeat center; text-decoration:none;margin-left:18px;" onclick="jobInvoiceDetail.loadData('+t.JobInvoiceID+')"></a>',r="&nbsp;&nbsp;&nbsp;";return o+r+i+l+'<a href="javascript:void(0)" onclick="deleteInvoice('+t.JobInvoiceID+')" class="action view" style="background:url(../../Images/delete-icon.png) no-repeat center; text-decoration:none;margin-left:18px;"></a>'},orderable:!1}],dom:"<<'table-responsive tbfix't><'paging grid-bottom prevar'p><'bottom'l><'clear'>>",bServerSide:!0,sAjaxSource:urlGetInvoiceList+$("#BasicDetails_JobID").val(),fnDrawCallback:function(){$("#datatable_wrapper").find(".bottom").find(".dataTables_paginate").remove(),$(".paging a.previous").html("&nbsp"),$(".paging a.next").html("&nbsp"),$(".grid-bottom span:first").attr("id","spanMain"),$("#spanMain span").html(""),$(".ellipsis").html("..."),$(".paging").find("span").length>1?$("#datatable_length").show():$("#datatable").find("tr").length>11?$("#datatable_length").show():$("#datatable_length").hide();var e=$("#datatable").DataTable(),a=e.page.info();0==a.recordsTotal?document.getElementById("invoiceNumRecords").innerHTML="<b>0</b>  of  <b>"+a.recordsTotal+"</b>  Invoice(s) found":document.getElementById("invoiceNumRecords").innerHTML="<b>"+$("#datatable >tbody >tr").length+"</b>  of  <b>"+a.recordsTotal+"</b>  Invoice(s) found"}}),$(".dataTables_empty").css("text-align","left")}function LoadCommonJobsWithSameInstallDateAndInstaller(){$.ajax({url:urlLoadCommonJobsWithSameInstallDateAndInstaller,type:"GET",data:{jobId:Model_JobID,installerId:$("#hdBasicDetails_InstallerID").val(),installationDate:$("#BasicDetails_strInstallationDate").val()},dataType:"json",success:function(e){if(e.commonJobs.length>0){for(var a='<div class="warning-notice" id="divWarning"><h5>Warning Notice:</h5> <br/> Installer: <b>'+e.commonJobs[0].InstallerName+"</b> has been already assigned the following jobs.",t=0;t<e.commonJobs.length;t++){var s="<b class=commonJobs>Company : </b>"+e.commonJobs[t].CompanyName,o=" <b class=commonJobs>Reseller : </b>"+e.commonJobs[t].ResellerName,i='<p>RefNumber : <a target="_blank" href="/Job/Index?id='+e.commonJobs[t].JobID+'"> '+e.commonJobs[t].RefNumber+" </a> "+s+o+"</p>";a+=i}a+="</div>",$("#loadCommonJobs").show(),$("#loadCommonJobs").html(a)}else $("#loadCommonJobs").html(""),$("#loadCommonJobs").hide();if(e.commonJobsWithFailedSTCStaus.length>0){for(a='<div class="warning-notice" id="divWarning"><h5>Warning Notice:</h5> <br/> Installer: <b>'+e.commonJobsWithFailedSTCStaus[0].InstallerName+"</b> has been already assigned the following jobs which have failed stc statuses.",t=0;t<e.commonJobsWithFailedSTCStaus.length;t++){s="<b class=commonJobs>Company : </b>"+e.commonJobsWithFailedSTCStaus[t].CompanyName,o=" <b class=commonJobs>Reseller : </b>"+e.commonJobsWithFailedSTCStaus[t].ResellerName,i='<p>RefNumber : <a target="_blank" href="/Job/Index?id='+e.commonJobsWithFailedSTCStaus[t].JobID+'"> '+e.commonJobsWithFailedSTCStaus[t].RefNumber+" </a> "+s+o+"</p>";a+=i}a+="</div>",$("#loadCommonJobsWithFailedStcStatus").show(),$("#loadCommonJobsWithFailedStcStatus").html(a)}else $("#loadCommonJobsWithFailedStcStatus").html(""),$("#loadCommonJobsWithFailedStcStatus").hide()}})}function ReloadSTCJobScreen(e,a){$("#loading-image").show(),setTimeout(function(){$.get(urlGetSTCJobNewScreen+jobID,function(e){$("#reloadSTCJobScreen").empty(),$("#reloadSTCJobScreen").append(e),a||1==ProjectSession_UserTypeId||3==ProjectSession_UserTypeId||$("#btnApplyTradeStc").hide(),10!=$("#STCStatusId").val()&&12!=$("#STCStatusId").val()&&14!=$("#STCStatusId").val()&&17!=$("#STCStatusId").val()&&($("#CESDocbtns").hide(),$("#STCDocBtns").hide(),$(".isdelete").css("display","none")),1!=ProjectSession_UserTypeId&&3!=ProjectSession_UserTypeId&&2!=ProjectSession_UserTypeId&&5!=ProjectSession_UserTypeId&&4!=ProjectSession_UserTypeId||($("#CESDocbtns").show(),$("#STCDocBtns").show()),1!=ProjectSession_UserTypeId&&3!=ProjectSession_UserTypeId||$(".isdelete").css("display","block"),1!=ProjectSession_UserTypeId&&3!=ProjectSession_UserTypeId&&10!=$("#STCStatusId").val()&&12!=$("#STCStatusId").val()&&14!=$("#STCStatusId").val()&&17!=$("#STCStatusId").val()&&$("#btnSaveJob").hide(),"True"==isSaveJobAfterTrade&&$("#btnSaveJob").show(),$("#loading-image").hide()})},500)}function SerialNumbersValidation(){var e=$("#hdnJobSystemDetails_SerialNumbers").val(),a=!1,t=!1;if(""!=e&&null!=e){var s=e.valueOf().trim(),o=s.split("\n");o=o.filter(function(e){return e.length>0});o.length;for(var i=0;i<o.length;i++)if(o[i].length>100){a=!0;break}t=hasDuplicates(o)}return a?(showErrorMessage("Serial numbers's maximum length is of 100 characters."),$("#spanSerialNumbers").show().text("Serial numbers's maximum length is of 100 characters.")):t?(showErrorMessage("Serial numbers should not be same."),$("#spanSerialNumbers").show().text("Serial numbers should not be same.")):$("#spanSerialNumbers").hide(),!a&&!t}function hasDuplicates(e){for(var a=[],t=0;t<e.length;++t){var s=e[t];if(-1!==a.indexOf(s))return!0;a.push(s)}return!1}function changeSCAModal(){$("#changeScaModal").modal()}function changeSCA(){var e=$("#inGBSCACode").val(),a=$("#GB_SCACode").val();null!=e&&""!=e&&e!=a?$.ajax({url:urlChangeSCA,dataType:"json",contentType:"application/json; charset=utf-8",type:"post",data:JSON.stringify({jobId:jobID,gbSCACode:e,resellerID:resellerID,oldSCAName:SCAName,solarCompanyId:SolarCompanyId,jobInstallationYear:JobInstallationYear}),success:function(a){a.success?(showMessageForChangeSCA(a.message,!1),$("#GB_SCACode").val(e)):showMessageForChangeSCA(a.message,!0)}}):e==a?showMessageForChangeSCA("You can not enter same SCA Code.",!0):$("#gbScaCodeError").html("GBSCA Code is required.")}function showMessageForChangeSCA(e,a){$(".alert").hide();var t=a?"errorMsgRegionChangeSCA":"successMsgRegionChangeSCA",s=a?"successMsgRegionChangeSCA":"errorMsgRegionChangeSCA";$("#"+s).hide(),$("#"+t).html(closeButton+e),$("#"+t).show()}function AddHistoryIcons(){$(".history-block li").each(function(){var e=$(this).attr("class");void 0!==e&&(e.includes("stage-status")?$(this).find(".border-icon").addClass("fa-regular fa-building"):e.includes("notes-status")?$(this).find(".border-icon").addClass("fa-regular fa-note-sticky"):e.includes("message-status")?$(this).find(".border-icon").addClass("message1"):e.includes("traded-status")?$(this).find(".border-icon").addClass("fa-regular fa-circle-dollar-to-slot"):e.includes("stc-status")?$(this).find(".border-icon").addClass("fa-solid fa-pen-to-square"):e.includes("scheduling-status")?$(this).find(".border-icon").addClass("fa-solid fa-briefcase"):e.includes("documents-status")?$(this).find(".border-icon").addClass("fa-regular fa-file-lines"):e.includes("signature-status")?$(this).find(".border-icon").addClass("fa-regular fa-file-signature"):e.includes("spvlogs-status")?$(this).find(".border-icon").addClass("fa-regular fa-clipboard-check"):e.includes("invoice-status")&&$(this).find(".border-icon").addClass("fa-regular fa-file-invoice-dollar"))})}function BindNotesType(){$.ajax({type:"GET",url:getnotestypeurl,dataType:"json",async:!1,data:{},success:function(e){$.each(e,function(e,a){"0"!=a.Value&&$("#post-visibility").append('<option value="'+a.Value+'">'+a.Text+"</option>"),$("#filter-postvisibility").append('<option value="'+a.Value+'">'+a.Text+"</option>")}),1!=ProjectSession_UserTypeId&&3!=ProjectSession_UserTypeId||$("#filter-postvisibility").append('<option value="5">Warning</option>')},error:function(e){alert("Failed to retrieve User list."+e)}})}function LoadWarningNotes(){var e=!1,a="5",t=$("#BasicDetails_JobID").val(),s="3",o="DESC";$("#loading-image").show(),$.ajax({url:urlLoadWarningNotes,type:"GET",data:{jobId:t,categoryID:0,order:o,PostVisibility:a,IsImportant:e,IsDeletedJobNote:s},cache:!1,async:!1,success:function(e){$("#warningNotesRegion").html($.parseHTML(e)),$("divCustom").mCustomScrollbar()}}),$("#loading-image").hide()}function BusinessValidationPop(e){return $(".modelBodyMessage").html(""),$(".modelBodyMessage").append(e.Data.ValidationSummary),$("#warning").modal(),!1}function SearchHistory(){var e=$("#historyCategory").val();e=null!=e?e:0;var a=FilterIsImportantNote_Glbl,t=$("#filter-postvisibility").val(),s=$("#BasicDetails_JobID").val(),o=$("#IsDeletedJobNote").val(),i="DESC";$("#loading-image").show(),setTimeout(function(){$.ajax({url:showhistoryUrl,type:"GET",data:{jobId:s,categoryID:e,order:i,PostVisibility:t,IsImportant:a,IsDeletedJobNote:o},cache:!1,async:!1,success:function(e){window.onbeforeunload=null,$("#showfilteredhistory").html($.parseHTML(e)),$("divCustom").mCustomScrollbar()}}),AddHistoryIcons(),hideEditDeleteIcons(),$("#loading-image").hide()},10)}function BindUserList(){$.ajax({type:"GET",url:userlisturl,dataType:"json",async:!1,data:{jobid:jobid},success:function(e){$("#relatedTofilter").prepend('<option value="0"> All </option>'),$.each(e,function(e,a){
" "!=a.Value&&$("#relatedTofilter").append('<option value="'+a.Value+'">'+a.Text+"</option>")})},error:function(e){alert("Failed to retrieve User list."+e)}})}function tagandsearchfilter(){var e=0,a=$("#relatedTofilter").val(),t="@"+a,s=$("#JobHistorySearch").val();if("0"==a?$("#divCustom .history-box").each(function(){$(this).text().search(new RegExp(s,"i"))<0?$(this).hide():($(this).show(),$("#norecords").empty(),e++)}):$("#divCustom .history-box").each(function(){$(this).text().search(new RegExp(t,"i"))<0||$(this).text().search(new RegExp(s,"i"))<0?$(this).hide():($(this).show(),$("#norecords").empty(),e++)}),e>0)$(".history-box").css("border-top","1px solid #e3e3e3");else{$("#norecords").empty();var o="<div style='text-align:center;font-size:24px;margin-top:120px'>No Record(s) Found.</div>";$("#norecords").append(o)}}function DownloadHistoryDocument(e){var a=$(e).attr("data-folder"),t=$(e).attr("data-name");window.location.href=BaseURLForJob+"ViewDownloadFileForStc/Job?FileName="+t+"&FolderName="+a}function DeleteNote(e){var a=$(e).attr("data-noteid"),t=jobID;$.ajax({type:"GET",url:urlDeleteNote,dataType:"json",async:!1,data:{Noteid:a,JobID:t},success:function(e){e.status?(showSuccessMessageJobHistory(e.message),SearchHistory()):showErrorMessageJobHistory(e.message)},error:function(e){showErrorMessageJobHistory("Failed to delete Job Note")}})}function EditNote(e){var a=$(e).attr("data-noteid"),t=jobID;$.ajax({type:"GET",url:urlEditNote,dataType:"json",async:!1,data:{Noteid:a,JobID:t},success:function(e){if(e.status){var t=function(){CKEDITOR.instances.contenteditor.focus(),CKEDITOR.instances.contenteditor.insertHtml(e.Notes)};CKEDITOR.instances.contenteditor.setData("",t),$("#post-visibility").val(e.NotesType),$("#IsImportantNote").prop("checked",e.IsImportant),$("#hiddenNoteID").val(a)}else showErrorMessageJobHistory(e.message)},error:function(e){showErrorMessageJobHistory("Failed to Open Job Note.")}})}function ReplyNote(e){var a=$(e).attr("data-noteid"),t=jobID;$.ajax({type:"GET",url:urlReplyNote,dataType:"json",async:!1,data:{Noteid:a,JobID:t},success:function(e){e.status?($("#popupAddReplyNote").modal({backdrop:"static",keyboard:!1}),$("#hdnReplyNoteID").val(a)):showErrorMessageJobHistory("Job Note has been deleted.")}})}function SaveReplyForNotes(){var e=$("#hdnReplyNoteID").val(),a=jobID,t=CKEDITOR.instances.notecontenteditor.getData(),s=jobRefNo;""!=t?$.ajax({type:"GET",url:urlSaveReplyForNote,dataType:"json",async:!1,data:{Noteid:e,JobID:a,NotesReplyDescription:t,JobRefNo:s},success:function(e){e.status?(showSuccessMessageJobHistory("Your reply has been added to Job Note."),$("#popupAddReplyNote").modal("toggle"),$("#hdnReplyNoteID").val(""),CKEDITOR.instances.notecontenteditor.setData(""),SearchHistory()):(showErrorMessageJobHistory("Your reply has not been saved to Job Note."),$("#popupAddReplyNote").modal("toggle"))}}):($("#errorMsgRegionJobReplyNote").html(closeButton+"Reply is required"),$("#errorMsgRegionJobReplyNote").show())}function ClearReplyForNotes(){CKEDITOR.instances.notecontenteditor.setData("")}function showSuccessMessageJobHistory(e){$("#errorMsgRegionJobHistory").hide(),$("#successMsgRegionJobHistory").html(closeButton+e),$("#successMsgRegionJobHistory").show()}function showErrorMessageJobHistory(e){$("#successMsgRegionJobHistory").hide(),$("#errorMsgRegionJobHistory").html(closeButton+e),$("#errorMsgRegionJobHistory").show()}function showEditDeleteIcons(){$(".IconsEditDelete").css("display","block")}function hideEditDeleteIcons(){$(".IconsEditDelete").each(function(){$(this).css("display","none !important")})}function CDMouseOut(){cdIsmouseIn=!1}function ShowHidePreapprovalBox(){$("#onOffSwitchPreApproval").prop("checked")?($("#preApprovalBox").show(),$("#onOffSwitchPreApproval").attr("ison",0)):($("#preApprovalBox").hide(),$("#onOffSwitchPreApproval").attr("ison",1))}function ShowHideConnectionBox(){$("#onOffSwitchConnection").prop("checked")?($("#connectionBox").show(),$("#onOffSwitchConnection").attr("ison",0)):($("#connectionBox").hide(),$("#onOffSwitchConnection").attr("ison",1))}function UpdateAction(){var e={IsPreapproval:$("#onOffSwitchPreApproval").prop("checked"),IsConnection:$("#onOffSwitchConnection").prop("checked"),JobId:jobID};$.ajax({url:urlSaveDefaultForJob,dataType:"json",contentType:"application/json; charset=utf-8",type:"post",data:JSON.stringify(e),success:function(e){e.status||e.error&&("sessiontimeout"==e.error.toLowerCase()?window.location.href=urlLogout:showErrorMessage(e.error))},error:function(){}})}function GetDefaultSettingForJob(){$.ajax({url:urlGetDefaultSettingsForJob,dataType:"json",contentType:"application/json; charset=utf-8",type:"get",success:function(e){if(e.status){var a=JSON.parse(e.data);$("#onOffSwitchPreApproval").prop("checked",a.IsPreapproval),ShowHidePreapprovalBox(),$("#onOffSwitchConnection").prop("checked",a.IsConnection),ShowHideConnectionBox()}else e.error&&("sessiontimeout"==e.error.toLowerCase()?window.location.href=urlLogout:showErrorMessage(e.error))},error:function(){}})}function UpdateActionToSaveIsNewViewerUserWise(){var e={IsNewViewer:$("#onOffSwitchNewDocVIewer").prop("checked")};$.ajax({url:urlSaveIsNewViewerUserWise,dataType:"json",contentType:"application/json; charset=utf-8",type:"post",data:JSON.stringify(e),success:function(e){"true"==e&&(fnDocViewerOuterPopup(),$("#IsNewViewer").val($("#onOffSwitchNewDocVIewer").prop("checked")))},error:function(){}})}function fnDocViewerOuterPopup(){$("#DocViewerOuterPopup").html(""),$("#DocViewerOuterPopup").load(urlDocViewerOuterPopup)}function DuplicateSerialNumbersValidation(e,a,t){var s=!1;if(null!=e.val()&&""!=e.val().trim()){var o=e.val().trim(),i=o.split("\n");i=i.filter(function(e){return e.length>0});i.length;for(var l=0;l<i.length;l++)if(i[l].length>100){s=!0;break}var r=hasDuplicatesSerialNumberOnPage(i,t)}return!s&&!r||(showErrorMessage(DuplicateSerialandInverterErrorMsg),!1)}function hasDuplicatesSerialNumberOnPage(e,a){ispanelorinverterduplicate=!1;for(var t=0;t<e.length;++t)for(var s=t+1;s<e.length;s++)e[t]==e[s]&&(lineNumberForDuplicateSerial=s+1,a?(DuplicatePanelSerialNumber=e[s],DuplicateSerialandInverterErrorMsg+="Panel Serial number "+DuplicatePanelSerialNumber+" is duplicate. "):(DuplicatePanelSerialNumber=e[s],DuplicateSerialandInverterErrorMsg+="Inverter Serial number "+DuplicatePanelSerialNumber+" is duplicate. "),ispanelorinverterduplicate=!0);return!!ispanelorinverterduplicate}var DuplicateSerialandInverterErrorMsg,dropDownData=[],isOwnerDetailsFetch=!1,isInstallationDetails=!1,isSTCDetails=!1,isSTCStatus=!1,isSystemDetails=!1,isSerialnumberDetails=!1,isInstallerDetails=!1,isScheduling=!1,isDocumentsPhotos=!1,isNotesHistory=!1,isWrittenStatementsDeclaration=!1,isRetailerDetails=!1,isPreApproval=!1,isCustomDetails=!1,isConnections=!1,UserIDforckeditor=0,isValidTabularData=!1,isTabularDataUpdated=!1;$(document).ready(function(){1!=ProjectSession_UserTypeId&&3!=ProjectSession_UserTypeId||LoadWarningNotes();var e=$("#cntWarningNotes").text();$("#btnWarningNotes").html("Warning Notes ("+e+")"),$("#btnWarningNotes").click(function(){$("#warningNotesRegion").toggle()}),$("#BasicDetails_strInstallationDate").val($("#BasicDetails_strInstallationDateTemp").val()),$("#pills-tab li:first-child a").tab("show"),""==$("#JobOwnerDetails_UnitTypeID option:selected").val()?($("#lblOwnerUnitNumber").removeClass("required"),$("#lblOwnerUnitTypeID").removeClass("required"),$("#lblOwnerStreetNumber").addClass("required")):($("#lblOwnerUnitNumber").addClass("required"),$("#lblOwnerUnitTypeID").addClass("required"),$("#lblOwnerStreetNumber").removeClass("required")),BindBasicDetailsValue(),$("#BasicDetails_strInstallationDate").change(function(){var e="",a=$("#BasicDetails_strInstallationDate").val();null!=a&&null!=a&&""!=a&&(e=moment(a,"DD/MM/YYYY").format("yyyy".toUpperCase())),$("#JobSTCDetails_DeemingPeriod").val(),BindDeemingPeriodDropdown(e,0)}),$("#hdnsolarCompanyid").val(SolarCompanyId_Glbl),$("#inGBSCACode").change(function(){null!=this.value&&""!=this.value?$("#gbScaCodeError").html(""):$("#gbScaCodeError").html("GBSCA Code is required.")}),CheckForChangeSCA()}),$("#STCJobStage_Tabular").change(function(){var e=$("#STCJobStage_Tabular option:selected").val(),a=$("#STCJobDetailsIdJobStage").val(),t="",s=!0,o=!0;if("CER Approved"!=currentStatus&&"New Submission"!=currentStatus){22!=e||5!=settlementTerm||isPartialValidForSTCInvoice?14==e&&"false"==isInvoiced&&(t="are you sure you want to change this status as per normal, and status change but no credit note is created because no invoice has been generated."):o=!1;jobID}else s=!1;if(o){if(!s)return alert("You can not change stc status of job which have CER Approved or New Submission STC status."),!1;""==t&&(t=22==e?"Are you sure you want to change stc status as CERApproved as you can not reverse it after change ?":"Are you sure you want to change stc status ?");var i=confirm(t);i&&$.ajax({type:"POST",url:urlChangeSTCJobStage,dataType:"json",contentType:"application/json; charset=utf-8",data:JSON.stringify({stcjobstage:e,jobID:jobID}),success:function(e){e.success?(showSuccessMessage("Job Stage Changed Successfully"),currentStatus=$("#STCJobStage_Tabular option:selected").text()):showErrorMessage(e.message)},error:function(e){showErrorMessage("job has not been saved."+e)}})}else alert("You can not change status to CERApproved which has STCStatus Partial and first invoice is not yet generated.")}),$('a[data-toggle="pill"]').on("shown.bs.tab",function(e){e.target,e.relatedTarget}),$("#btnViewHistory").click(function(e){e.preventDefault(),$("#JobHistoryOfJob").load(urlShowHistory+urlRequestContext,function(){$("#JobHistory").modal({backdrop:"static",keyboard:!1})})}),$("#nxtTab").click(function(e){e.preventDefault(),$("li.resp-tab-active").next().click(),$("#successMsgRegionSTCDetails").hide(),$("#errorMsgRegionSTCDetails").hide(),$("#spnTabIndex").text($("li.resp-tab-active").index()+1)}),$("#prevTab").click(function(e){e.preventDefault(),$("li.resp-tab-active").prev().click(),$("#successMsgRegionSTCDetails").hide(),$("#errorMsgRegionSTCDetails").hide(),$("#spnTabIndex").text($("li.resp-tab-active").index()+1)}),$("#btnCancelSave").click(function(e){e.preventDefault();var a=$("#horizontalTab").find("li.active").attr("id");$("#BasicDetails_JobID").val();"basic"==a?location.reload(!0):"owner"==a?(isOwnerDetailsFetch=!1,$(".tab1").empty(),BindPartialView("Owner Details",2)):"system"==a?(isSystemDetails=!1,$(".tab2").empty(),BindPartialView("System Details",5)):"installer"==a?(isInstallerDetails=!1,$(".tab3").empty(),BindPartialView("Installer Details",6)):"stc"==a?(isSTCDetails=!1,$(".tab4").empty(),BindPartialView("STC Details",4)):"stcstatus"==a?(isSTCStatus=!1,$(".tab12").empty(),BindPartialView("STC Status",4)):"installation"==a?(isInstallationDetails=!1,$(".tab5").empty(),BindPartialView("Installation Details",3)):"customdetails"==a?(isCustomDetails=!1,$(".tab15").empty(),BindPartialView("Custom Details",3)):"documents"==a?(isSerialnumberDetails=!1,isDocumentsPhotos=!1,$(".tab8").empty(),BindPartialView("DocumentsPhotos",8)):"notes-history"==a&&($(".tab9").empty(),BindPartialView("NotesHistory",9))}),$("#btnSaveTab").click(function(e){isValidTabularData||(isValidTabularData=validTabularPage()),isValidTabularData&&(0==isOverRideSave?(e.preventDefault(),checkBusinessRules(!1)):(TabularView.UpdateBasicDetail(),1==isInstallationDetails&&TabularView.UpdateInstallationDetail(),1==isCustomDetails&&TabularView.UpdateCustomDetail(),1==isSystemDetails&&TabularView.UpdateSystemDetail(),1==isSTCDetails&&(TabularView.UpdateStcDetail(),TabularView.UpdateGstDetail()),1!=isSerialnumberDetails&&1!=isDocumentsPhotos||TabularView.UpdateSerialNumberDetail(),isTabularDataUpdated&&(isOverRideSave=!1)))});var TabularView={UpdateBasicDetail:function(e){if($("#frmBasicDetail").valid()&&isValidTabularData){$("#SSCID").prop("disabled",!1);var a=urlUpdateBasicDetail,t=$("#frmBasicDetail").serializeToJson();t.isOverRideSave=isOverRideSave,getDataTabular(a,t,function(e){e.status?(isTabularDataUpdated=!0,TabularView.UpdateOwnerDetail(),$("#SSCID").val(),$("#SSCID").prop("disabled",!1)):(showErrorMessage("Basic details has not been saved."),""!=$("#SSCID").val()?$("#SSCID").prop("disabled",!0):$("#SSCID").prop("disabled",!1),isTabularDataUpdated=!1)})}},UpdateOwnerDetail:function(){$("#JobOwnerDetails_JobID").val(BasicDetails_JobID);var e=JobInstallationDetails_PropertyType,a=$("#JobOwnerDetails_Email").val();if("commercial"==e.toLowerCase()&&(null==a||""==a))return showErrorMessage("Owner email address is mandatory for commercial jobs."),isValidTabularData=!1,!1;if("school"==e.toLowerCase()&&(null==a||""==a))return showErrorMessage("Owner email address is mandatory for installation property type school."),isValidTabularData=!1,!1;if($("#frmBasicDetail").valid()&&isValidTabularData){var t=urlUpdateOwnerDetail,s=!1;s=null!=$("#BasicDetails_IsGst").val()&&""!=$("#BasicDetails_IsGst").val()?$("#BasicDetails_IsGst").prop("checked"):modelbasicdetailsIsGST,data=$("#frmBasicDetail").serializeToJson().JobOwnerDetails,data.isGST=s,data.isOverRideSave=isOverRideSave,getDataTabular(t,data,function(e){return e.status?(OwnerAddressJson=[],1==$("#JobOwnerDetails_AddressID").val()?OwnerAddressJson.push({CompanyABN:$("#JobOwnerDetails_CompanyABN").val(),OwnerType:$("#JobOwnerDetails_OwnerType").val(),CompanyName:$("#JobOwnerDetails_CompanyName").val(),Phone:$("#JobOwnerDetails_Phone").val(),Mobile:$("#JobOwnerDetails_Mobile").val(),FirstName:$("#JobOwnerDetails_FirstName").val(),LastName:$("#JobOwnerDetails_LastName").val(),Email:$("#JobOwnerDetails_Email").val(),PostalAddressType:$("#JobOwnerDetails_AddressID").val(),UnitType:$("#JobOwnerDetails_UnitTypeID").val(),UnitNumber:$("#JobOwnerDetails_UnitNumber").val(),StreetNumber:$("#JobOwnerDetails_StreetNumber").val(),StreetName:$("#JobOwnerDetails_StreetName").val(),StreetType:$("#JobOwnerDetails_StreetTypeID").val(),Town:$("#JobOwnerDetails_Town").val(),State:$("#JobOwnerDetails_State").val(),PostCode:$("#JobOwnerDetails_PostCode").val()}):OwnerAddressJson.push({CompanyABN:$("#JobOwnerDetails_CompanyABN").val(),OwnerType:$("#JobOwnerDetails_OwnerType").val(),CompanyName:$("#JobOwnerDetails_CompanyName").val(),Phone:$("#JobOwnerDetails_Phone").val(),Mobile:$("#JobOwnerDetails_Mobile").val(),FirstName:$("#JobOwnerDetails_FirstName").val(),LastName:$("#JobOwnerDetails_LastName").val(),Email:$("#JobOwnerDetails_Email").val(),PostalAddressType:$("#JobOwnerDetails_AddressID").val(),PostalAddressID:$("#JobOwnerDetails_PostalAddressID").val(),PostalDeliveryNumber:$("#JobOwnerDetails_PostalDeliveryNumber").val(),Town:$("#JobOwnerDetails_Town").val(),State:$("#JobOwnerDetails_State").val(),PostCode:$("#JobOwnerDetails_PostCode").val()}),isTabularDataUpdated=!0,!isTabularDataUpdated||isInstallationDetails||isCustomDetails||isSystemDetails||isSTCDetails||isDocumentsPhotos?isTabularDataUpdated&&(isInstallationDetails||isCustomDetails||isSystemDetails||isSTCDetails||isDocumentsPhotos)?showSuccessMessage("Job details has been saved successfully"):showErrorMessage("Job details has not been saved."):showSuccessMessage("Job details has been saved successfully"),!0):(showErrorMessage("Owner details has not been saved."),!1)})}},UpdateStcDetail:function(){var e=$("#JobInstallationDetails_PropertyType").val(),a=$("#JobOwnerDetails_Email").val(),t=$("#JobSTCDetails_Latitude").val(),s=$("#JobSTCDetails_Longitude").val(),o=/^[-+]?[0-9]+\.[0-9]+$/;if(""!=t&&!t.match(o))return showErrorMessage("Please enter latitude in decimal format of STC job details."),isValidTabularData=!1,!1;if(""!=s&&!s.match(o))return showErrorMessage("Please enter longitude in decimal format of STC job details."),isValidTabularData=!1,!1;if("commercial"==e.toLowerCase()&&(null==a||""==a))return showErrorMessage("Owner email address is mandatory for commercial jobs."),isValidTabularData=!1,!1;if("school"==e.toLowerCase()&&(null==a||""==a))return showErrorMessage("Owner email address is mandatory for installtion property type school."),isValidTabularData=!1,!1;if(isValidTabularData){var i=urlUpdateStcDetail,l=$("#frmStcDetail").serializeToJson();l.JobType=$("#BasicDetails_JobType").val(),l.isOverRideSave=isOverRideSave,getDataTabular(i,l,function(e){return e.status?(ReloadSTCModule(),isTabularDataUpdated=!0,!0):(showErrorMessage("Stc details has not been saved."),!1)})}},UpdateInstallationDetail:function(){var e=$("#txtAddress1").val();if(""==e.trim()||null==e||null==e)return $("#spantxtAddress").show(),isValidTabularData=!1,!1;$("#spantxtAddress").hide();var a=addressValidationRules("JobInstallationDetails");if(isValidTabularData=a,$("#JobInstallationDetails_JobID").val(BasicDetails_JobID),$("#frmInstallationDetail").valid()&&a&&isValidTabularData){var t=JSON.stringify($("#frmInstallationDetail").serializeToJson()),s=JSON.parse(t),o=JSON.stringify($("#JobInstallationAddress").serializeToJson()),i=JSON.parse(o),l=JSON.stringify($("#JobInstallationDetailInfo").serializeToJson()),r=JSON.parse(l),n=JSON.stringify($("#JobExtraInstallationInfo").serializeToJson()),d=JSON.parse(n);$.extend(s.JobInstallationDetails,i.JobInstallationDetails),$.extend(s.JobInstallationDetails,r.JobInstallationDetails),$.extend(s.JobInstallationDetails,d.JobInstallationDetails);var c=s;c.isOverRideSave=isOverRideSave;var u=urlUpdateInstallationDetail;getDataTabular(u,c,function(e){return e.status?(isTabularDataUpdated=!0,!0):(showErrorMessage("Installation details has not been saved."),!1)})}},UpdateCustomDetail:function(){if($("#JobInstallationDetails_JobID").val(BasicDetails_JobID),$("#frmCustomDetails").valid()&&isValidTabularData){var e=JSON.stringify($("#frmCustomDetails").serializeToJson()),a=JSON.parse(e),t=[];$("#customDetails").find(".spanCustomFields").each(function(){t.push({JobCustomFieldId:$(this).attr("data-jobcustomfieldid"),FieldValue:$(this).val(),SeparatorId:$(this).attr("data-SeperatorId")})}),a.lstCustomDetails=t;for(var s=$("#customDetails").find(".spanCustomFields").length,o=0;o<s;o++)delete a["lstCustomDetails["+o+"]"];var i=a;i.isOverRideSave=isOverRideSave,i.JobId=BasicDetails_JobID;var l=urlUpdateCustomDetail;getDataTabular(l,i,function(e){return e.status?(isTabularDataUpdated=!0,!0):(showErrorMessage("Custom detail has not been saved."),!1)})}},UpdateSystemDetail:function(){var e="",a="",t=[];if(t=JSON.parse(JSON.stringify(batteryXml)),PanelXml.length>0){var s=JSON.stringify(PanelXml),o="",i=$.parseJSON(s);$.each(i,function(){o+="<panel><Brand>"+htmlEncode(this.Brand)+"</Brand><Model>"+htmlEncode(this.Model)+"</Model><NoOfPanel>"+this.Count+"</NoOfPanel><Supplier>"+htmlEncode(this.Supplier)+"</Supplier></panel>"}),e="<Panels>"+o+"</Panels>"}if(InverterXml.length>0){s=JSON.stringify(InverterXml),o="",i=$.parseJSON(s);$.each(i,function(){o+="<inverter><Brand>"+htmlEncode(this.Brand)+"</Brand><Model>"+htmlEncode(this.Model)+"</Model><Series>"+htmlEncode(this.Series)+"</Series><NoOfInverter>"+htmlEncode(this.NoOfInverter)+"</NoOfInverter><Supplier>"+htmlEncode(this.Supplier)+"</Supplier></inverter>"}),a="<Inverters>"+o+"</Inverters>"}$("#panelXml").val(e),$("#inverterXml").val(a),$("#JobSystemDetails_jobTypeTab").val(jobType),$("#JobSystemDetails_JobID").val(BasicDetails_JobID),$("#OldPanelDetails").val(JSON.stringify(OldPanelXml)),$("#NewPanelDetails").val(JSON.stringify(PanelXml));var l,r=JSON.stringify($("#frmSystemDetail").serializeToJson()),n={},d=JSON.parse(r).JobSystemDetails;if(d.ModifiedCalculatedSTC=1==$("#BasicDetails_JobType").val()?$("#JobSystemDetails_CalculatedSTC").val():$("#JobSystemDetails_CalculatedSTCForSWH").val(),d.NoOfPanel=$("#JobSystemDetails_NoOfPanel").html(),d.InstallationType=$("#JobSystemDetails_InstallationType").val(),systemXml.length>0&&(d.SystemBrand=systemXml[0].Brand,d.SystemModel=systemXml[0].Model),d.panelXmlTabular=e,d.inverterXmlTabular=a,d.SerialNumbers=$("#JobSystemDetails_SerialNumbers").val(),d.InverterSerialNumbers=$("#JobSystemDetails_InverterSerialNumbers").val(),t.length>0){for(var c=0;c<t.length;c++)delete t[c].JobBatteryManufacturerId;d.lstJobBatteryManufacturer=t,"select"==$("#JobSTCDetails_batterySystemPartOfAnAggregatedControl").val().toLowerCase()?d.batterySystemPartOfAnAggregatedControl="":d.batterySystemPartOfAnAggregatedControl=$("#JobSTCDetails_batterySystemPartOfAnAggregatedControl").val(),"select"==$("#JobSTCDetails_changedSettingOfBatteryStorageSystem").val().toLowerCase()?d.changedSettingOfBatteryStorageSystem="":d.changedSettingOfBatteryStorageSystem=$("#JobSTCDetails_changedSettingOfBatteryStorageSystem").val()}l=1==$("#BasicDetails_JobType").val()?!!($("#BasicDetails_strInstallationDate").val()&&$("#JobSTCDetails_DeemingPeriod").val()&&$("#JobInstallationDetails_PostCode").val()):!!(systemXml.length>0&&systemXml[0].Brand&&systemXml[0].Model&&$("#JobInstallationDetails_PostCode").val());var u,b=$("#JobSystemDetails_SystemSize").val()>0,m=!!$("#BasicDetails_strInstallationDate").val();if(u=1==$("#BasicDetails_JobType").val()?!b||b&&l:!m||m&&l,isValidTabularData=u,n.objSystem=d,n.OldPanelDetails=$("#OldPanelDetails").val(),n.NewPanelDetails=$("#NewPanelDetails").val(),n.isOverRideSave=isOverRideSave,isValidTabularData)if(u){var S=urlUpdateSystemDetail;getDataTabular(S,n,function(e){if(e.status){if(OldPanelXml=[],OldPanelXml=JSON.parse(JSON.stringify(PanelXml)),1==e.jobType?e.STCValue>0?$("#JobSystemDetails_CalculatedSTC").val(e.STCValue):$("#JobSystemDetails_CalculatedSTC").val(""):e.STCValue>0?$("#JobSystemDetails_CalculatedSTCForSWH").val(e.STCValue):$("#JobSystemDetails_CalculatedSTCForSWH").val(""),ReloadSTCModule(),serialNumber=e.serialnumbers,$("div.line-no").removeClass("verified"),$("div.line-no").removeClass("unverified"),$("div.line-no").removeClass("installationVerified"),$("div.line-no").removeClass("notverified"),$("#GlobalisAllowedSPV").val(e.GlobalisAllowedSPV),e.IsSPVRequired){IsSPVRequired="True",VerifyUnVerifySerialNumber();var a=serialNumber.find(e=>null==e.IsVerified);null!=a&&"true"==$("#GlobalisAllowedSPV").val().toLowerCase()&&"True"==IsSPVRequired?$(".isSPVRequired").show():$(".isSPVRequired").hide()}else $(".isSPVRequired").hide(),$("#SPVLabel").hide(),IsSPVRequired="False";return isTabularDataUpdated=!0,!0}return showErrorMessage("System details has not been saved."),!1})}else{if(1==$("#BasicDetails_JobType").val())return showErrorMessage("Please fill Installation Date, STC DeemingPeriod, Installation postcode to set STC value."),!1;showErrorMessage("Please fill Installation Date, System brand, System Model, Installation postcode to set STC value.")}},UpdateSerialNumberDetail:function(){var e={},a=!0;if($("#JobSystemDetails_JobID").val(BasicDetails_JobID),null==$("#JobSystemDetails_JobID").val()&&(a=!1),!a)return!0;var t={SerialNumbers:$("#JobSystemDetails_SerialNumbers").val(),InverterSerialNumbers:$("#JobSystemDetails_InverterSerialNumbers").val(),JobID:BasicDetails_JobID};e.objSystem=t;var s=!1,o=!1;if("false"==isPanelSerialNumber.toLowerCase()&&8==ProjectSession_UserTypeId?s=!0:(s=DuplicateSerialNumbersValidation($("#JobSystemDetails_SerialNumbers"),$("#spanSerialNumbers"),!0),o=DuplicateSerialNumbersValidation($("#JobSystemDetails_InverterSerialNumbers"),$("#spanInverterSerialNumbers"),!1),s&&o||(isValidTabularData=!1)),e.isOverRideSave=isOverRideSave,!s||!isValidTabularData)return showErrorMessage("Serial number should not be same."),isValidTabularData=!1,!1;var i=urlUpdateSerialNoDetail;getDataTabular(i,e,function(e){if(e.status){if(serialNumber=e.serialnumbers,$("div.line-no").removeClass("verified"),$("div.line-no").removeClass("unverified"),$("div.line-no").removeClass("installationVerified"),$("div.line-no").removeClass("notverified"),$("#GlobalisAllowedSPV").val(e.GlobalisAllowedSPV),e.IsSPVRequired){IsSPVRequired="True",VerifyUnVerifySerialNumber();var a=serialNumber.find(e=>null==e.IsVerified);null!=a&&"true"==$("#GlobalisAllowedSPV").val().toLowerCase()&&"True"==IsSPVRequired?$(".isSPVRequired").show():$(".isSPVRequired").hide()}else $(".isSPVRequired").hide(),$("#SPVLabel").hide(),IsSPVRequired="False";return LoadCommonSerialNumber(),LoadCommonInverterSerialNumber(),checkSerialNumberWithPhotoExistOrNot(),isTabularDataUpdated=!0,!0}return showErrorMessage("Serial number details has not been saved."),!1})},UpdateGstDetail:function(){if(isValidTabularData){var e={isGST:$("#BasicDetails_IsGst").prop("checked"),FileName:$("#BasicDetails_GSTDocument").val(),jobId:BasicDetails_JobID},a=urlUpdateGstDetail;getDataTabular(a,e,function(e){return e.status?(isTabularDataUpdated=!0,!0):(showErrorMessage("GST detail has not been saved."),!1)})}}};$("#aSwitch").click(function(e){window.location.href="/Job/Index?Id="+eJobId+"&isTabularView=false"}),$("#btnJobPrint").click(function(){var e=urlPrint+$(this).attr("jobid");window.open(e)}),$("#btnBackNew").click(function(e){e.preventDefault(),isParentInvoice?($(document).attr("title","GreenBot - Invoice"),$("#createJobView").hide(),$("#createJobNotes").hide(),$("#createJobMessage").hide(),$("#history").hide(),$(".assign").hide(),IsLast=!1,pageIndex=1,$("#invoice").load(urlGetJobInvoice),$("#invoice").show(),$("#EmailConversation").hide(),$("#invoiceDetail").css("display","none"),setTimeout(function(){loadInvoice()},1500)):window.location.href=urlIndex}),$("#yesWarning").click(function(){$("#warning").modal("hide"),isOverRideSave=!0,$("#btnSaveTab").click()}),$("#noWarning").click(function(){$("#warning").modal("hide"),"0"!=$("#BasicDetails_JobID").val()&&($("#BasicDetails_JobType").attr("disabled","disabled"),$("#BasicDetails_JobType").change())}),$("#CloseWarning").click(function(){$("#STCwarning").modal("hide"),"0"!=$("#BasicDetails_JobID").val()&&($("#BasicDetails_JobType").attr("disabled","disabled"),$("#BasicDetails_JobType").change())}),$("#aViewSTCJobHistory").click(function(){$.get(GetSTCJobHistory+Model_JobID,function(e){$("#STCJobHistoryOfJob").empty(),$("#STCJobHistoryOfJob").append(e),$("#popupSTCJobHistory").modal({backdrop:"static",keyboard:!1})})}),$("#closePopupSTCJobHistory").click(function(){$("#popupSTCJobHistory").modal("toggle")}),$("#onOffSwitchPreApproval").on("change.bootstrapSwitch",function(e,a){ShowHidePreapprovalBox(),BindPartialView("PreApproval",12),$("#txtPreapprovalComment").val($("#spanPreapprovalComment").html()),$("#preApprovalConnectionVal").val(1),UpdateAction()}),$("#onOffSwitchConnection").on("change.bootstrapSwitch",function(e,a){ShowHideConnectionBox(),BindPartialView("Connection",13),$("#txtConnComment").val($("#spanConnectionComment").html()),$("#preApprovalConnectionVal").val(2),UpdateAction()}),$("#onOffSwitchNewDocVIewer").on("change.bootstrapSwitch",function(e,a){UpdateActionToSaveIsNewViewerUserWise()}),$("#aDeleteJob").click(function(e){if(e.preventDefault(),selectedRows=[],jobDetail={id:Model_Id,jobTitle:$("#BasicDetails_Title").val()},selectedRows.push(jobDetail),null!=selectedRows&&selectedRows.length>0){var a=confirm("Are you sure you want to delete selected jobs ?");a&&$.ajax({url:urlDeleteSelectedJobs,type:"POST",cache:!1,data:JSON.stringify({jobs:selectedRows}),dataType:"json",contentType:"application/json; charset=utf-8",success:function(e){"Completed"==e.JsonResponseObj.status?(showSuccessMessage("Job has been deleted."),window.location.href="/Job/Index"):showErrorMessage(e.JsonResponseObj.strErrors)}})}else alert("Please select any job for delete.")}),$("#aGetSignatureSelfie").click(function(e){e.preventDefault(),$("#mdlGetSignatureSelfie").modal("show")}),$("#btnDownloadJobFullPack").click(function(e){window.location.href=urlGetFullJobPack+"?JobID="+eJobId});