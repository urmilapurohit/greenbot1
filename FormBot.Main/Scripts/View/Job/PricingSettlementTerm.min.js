function PricingSettlementTermOnLoad(){"False"!=IsShowInDashboard&&"True"!=IsTradedFromJobIndex||1==IsSubmissionScreen||0==currentJobStatus||!(1==session_UserTypeId||3==session_UserTypeId||(2==session_UserTypeId||4==session_UserTypeId||5==session_UserTypeId||8==session_UserTypeId&&"True"==showbtn)&&(12==currentJobStatus||17==currentJobStatus||14==currentJobStatus||"New"!=$("#JobInstallationDetails_InstallingNewPanel").val()&&""!=$("#JobInstallationDetails_InstallingNewPanel").val()||"New"==$("#JobInstallationDetails_InstallingNewPanel").val()&&!isJobWithCommonInstallationAddress))?DisableTradeButton():EnableTradeButton(),($("#IsWholeSaler").val()&&"true"==$("#IsWholeSaler").val().toLowerCase()||BasicDetails_IsWholeSaler&&"true"==BasicDetails_IsWholeSaler.toLowerCase())&&"false"==isWholesalerSCAPricingSettlementTermView?($(".SettlementTerms").hide(),$("#calculatedSTCParent").hide(),$(".total-amonut").hide(),$(".stc-amount").hide(),$(".SettlementTermsCERApproved").hide()):($(".SettlementTerms").show(),$("#calculatedSTCParent").show(),$(".total-amonut").show(),$(".stc-amount").show(),$(".SettlementTermsCERApproved").show()),BasicDetails_IsWholeSaler&&"true"==BasicDetails_IsWholeSaler.toLowerCase()&&"true"==IsForDashboardPricingWholesaler.toLowerCase()&&($(".SettlementTerms").show(),$("#calculatedSTCParent").show(),$(".total-amonut").show(),$(".stc-amount").show(),$(".SettlementTermsCERApproved").show()),"True"==IsShowInDashboard&&$("#calculatedSTCParent").hide(),1!=session_UserTypeId&&3!=session_UserTypeId&&10!=model_STCStatus&&12!=model_STCStatus&&14!=model_STCStatus&&17!=model_STCStatus&&($("#PricingBlock").hide(),"undefined"!=typeof TabularView&&$(".subTitleSTCPricing").hide()),12!=statucId&&17!=statucId&&1!=session_UserTypeId&&($("ul.Processing-time li.LiSettlement").addClass("cursorDefault"),$("ul.Processing-time li.LiSettlement").unbind("click")),1!=IsSubmissionScreen&&"false"==model_IsDashboardPricing&&EnableDisableSettlementTerm(),$(".LiSettlement").each(function(){$(this).click(function(){SettlementTermClick($(this))}),$(this).data("settlementterm")==settlementTerm&&$(this).click(),"True"==IsShowInDashboard&&("True"==$(this).attr("data-ispriceup")?$(this).addClass("up-caret"):$(this).addClass("down-caret"))}),"0"==settlementTerm&&$(".LiSettlement:first").click(),"false"==model_IsGridView&&(x=document.createElement("div"),x.innerHTML=Description,$("#lblDescription").html($(x).html()),$("#lblLastUpdatedDate").html(lastUpdatedDate));var e=$(".Processing-time").find("li").length,t=0;e>0&&(t=100/e+"%"),$(".Processing-time").find("li").css("width",t)}function SettlementTermClick(e){e.attr("data-settlementterm"),e.children("#CustomSettlementTerm").val()>0&&e.children("#CustomSettlementTerm").val();$(".LiSettlement").removeClass("active"),e.children(".ui-state-disabled").length>0?e.parent().children("li").children("span:not(.ui-state-disabled)").parent("li:first").addClass("active"):e.addClass("active"),10!=model_STCStatus&&12!=model_STCStatus&&14!=model_STCStatus&&17!=model_STCStatus||calculateTotal(e)}function TradeSTCCheckRemarkandProceed(){STCRemark=$("#txtstcremark").val(),null==STCRemark||""==STCRemark?$("#errormsgtxtstcremark").show():($("#errormsgtxtstcremark").hide(),$("#popupstcRemark").modal("toggle"),ApplyTradeStc())}function ApplyTradeForStc(){"New"==$("#JobInstallationDetails_InstallingNewPanel").val()&&""!=$("#JobInstallationDetails_InstallingNewPanel").val()||!isJobWithCommonInstallationAddress?ApplyTradeStc():$("#popupstcRemark").modal({backdrop:"static",keyboard:!1})}function ApplyTradeStc(){var e=$("#imgOwnerSign").attr("src");if(null!=e){var t="false"==BasicDetails_IsWholeSaler.toLowerCase()?$(".LiSettlement.active").data("interval"):$(".LiSettlement").data("interval"),a="false"==BasicDetails_IsWholeSaler.toLowerCase()?$(".LiSettlement.active").data("price"):$(".LiSettlement").data("price"),s="false"==BasicDetails_IsWholeSaler.toLowerCase()?$(".LiSettlement.active").data("settlementterm"):$(".LiSettlement").data("settlementterm");if(12==s&&(peakPayTimePeriodValue=peakPayTimePeriod,peakPayGstRate=PeakPayGst,peakPayFeeValue=PeakPayFee),10==s&&12==customSettlementTerm&&(peakPayTimePeriodValue=peakPayCustomTimePeriod,peakPayGstRate=CustomPeakPayGst,peakPayFeeValue=CustomPeakPayFee),BasicDetails_IsWholeSaler&&"false"==BasicDetails_IsWholeSaler.toLowerCase()&&0==$(".LiSettlement.active").length)alert("Please select atleast one settlement term.");else if("true"==BasicDetails_IsWholeSaler.toLowerCase()&&1==$(".Processing-time").find(".LiSettlement").length||"false"==BasicDetails_IsWholeSaler.toLowerCase())if("true"==model_IsGridView){var r=!0,o=0,i=0,l=0,n=0,c=0,m=0,d=0,p=0,h=0,u=0,S=!0,y=[];$('#datatable1 tbody input[type="checkbox"]').each(function(){if(1==$(this).prop("checked"))if("True"==IsShowInDashboard){if("true"==$(this).attr("IsTraded")||"true"==$(this).attr("IsCustomPrice"))return!1,S=!1,alert("Please select jobs which are neither traded nor have custom price."),!1;if("true"!=$(this).attr("IsReadyToTrade"))return!1,S=!1,alert("Please select jobs which are ready to trade."),!1;if(r)o=parseFloat($(this).attr("PriceDay1")),i=parseFloat($(this).attr("PriceDay3")),l=parseFloat($(this).attr("PriceDay7")),n=parseFloat($(this).attr("PriceOnApproval")),c=parseFloat($(this).attr("RapidPay")),m=parseFloat($(this).attr("OptiPay")),d=parseFloat($(this).attr("Commercial")),p=parseFloat($(this).attr("Custom")),h=parseFloat($(this).attr("InvoiceStc")),u=parseFloat($(this).attr("PeakPay")),!0,y.push($(this).attr("jobid"));else{if(o!=parseFloat($(this).attr("PriceDay1"))||i!=parseFloat($(this).attr("PriceDay3"))||l!=parseFloat($(this).attr("PriceDay7"))||n!=parseFloat($(this).attr("PriceOnApproval"))||c!=parseFloat($(this).attr("RapidPay"))||m!=parseFloat($(this).attr("OptiPay"))||d!=parseFloat($(this).attr("Commercial"))||p!=parseFloat($(this).attr("Custom"))||h!=parseFloat($(this).attr("InvoiceStc"))||u!=parseFloat($(this).attr("PeakPay")))return!1,S=!1,alert("Please select jobs which have same price."),!1;!0,y.push($(this).attr("jobid"))}r=!1}else{if(4!=s&&8!=s&&12!=s&&4!=customSettlementTerm&&8!=customSettlementTerm&&12!=customSettlementTerm&&"true"==$(this).attr("isApproachingExpiryDate"))return alert("Approaching 12-month expiry date for claiming STCs. This job can only be traded on approval. Please contact your account manager for further details."),S=!1,!1;y.push($(this).attr("JobId"))}}),1==S&&(y.length>0?confirm("Are you sure you want to Trade STC?")&&ApplyTradeActual(y.join(","),t,a,s,peakPayGstRate,peakPayTimePeriodValue,peakPayFeeValue,"STC"):alert("Please select atleast one job."))}else 4!=s&&8!=s&&12!=s&&4!=customSettlementTerm&&8!=customSettlementTerm&&12!=customSettlementTerm&&"true"==$("#IsApproachingExpiryDate").val().toLowerCase()?alert("Approaching 12-month expiry date for claiming STCs. This job can only be traded on approval. Please contact your account manager for further details."):ApplyTradeActual(model_JobId,t,a,s,peakPayGstRate,peakPayTimePeriodValue,peakPayFeeValue,"STC");else alert("Oops, there is an error in the backend, please contact a Greenbot admin")}else alert("Please Upload Owner Signature To Trade STC")}function ApplyTradeSAAS(){var e="false"==BasicDetails_IsWholeSaler.toLowerCase()?$(".LiSettlement.active").data("interval"):$(".LiSettlement").data("interval"),t="false"==BasicDetails_IsWholeSaler.toLowerCase()?$(".LiSettlement.active").data("price"):$(".LiSettlement").data("price"),a="false"==BasicDetails_IsWholeSaler.toLowerCase()?$(".LiSettlement.active").data("settlementterm"):$(".LiSettlement").data("settlementterm");if(0!=$(".LiSettlement.active").length)if(1==$(".Processing-time").find(".LiSettlement.active").length)if("true"==model_IsGridView){var s=!0,r=0,o=0,i=0,l=0,n=0,c=0,m=0,d=0,p=0,h=0,u=!0,S=[];$('#datatable1 tbody input[type="checkbox"]').each(function(){if(1==$(this).prop("checked"))if("True"==IsShowInDashboard){if("true"==$(this).attr("IsTraded")||"true"==$(this).attr("IsCustomPrice"))return!1,u=!1,alert("Please select jobs which are neither traded nor have custom price."),!1;if("true"!=$(this).attr("IsReadyToTrade"))return!1,u=!1,alert("Please select jobs which are ready to trade."),!1;if(s)r=parseFloat($(this).attr("PriceDay1")),o=parseFloat($(this).attr("PriceDay3")),i=parseFloat($(this).attr("PriceDay7")),l=parseFloat($(this).attr("PriceOnApproval")),n=parseFloat($(this).attr("RapidPay")),c=parseFloat($(this).attr("OptiPay")),m=parseFloat($(this).attr("Commercial")),d=parseFloat($(this).attr("Custom")),p=parseFloat($(this).attr("InvoiceStc")),h=parseFloat($(this).attr("PeakPay")),!0,S.push($(this).attr("jobid"));else{if(r!=parseFloat($(this).attr("PriceDay1"))||o!=parseFloat($(this).attr("PriceDay3"))||i!=parseFloat($(this).attr("PriceDay7"))||l!=parseFloat($(this).attr("PriceOnApproval"))||n!=parseFloat($(this).attr("RapidPay"))||c!=parseFloat($(this).attr("OptiPay"))||m!=parseFloat($(this).attr("Commercial"))||d!=parseFloat($(this).attr("Custom"))||p!=parseFloat($(this).attr("InvoiceStc"))||h!=parseFloat($(this).attr("PeakPay")))return!1,u=!1,alert("Please select jobs which have same price."),!1;!0,S.push($(this).attr("jobid"))}s=!1}else{if(4!=a&&8!=a&&12!=a&&4!=customSettlementTerm&&8!=customSettlementTerm&&12!=customSettlementTerm&&"true"==$(this).attr("isApproachingExpiryDate"))return alert("Approaching 12-month expiry date for claiming STCs. This job can only be traded on approval. Please contact your account manager for further details."),u=!1,!1;S.push($(this).attr("JobId"))}}),1==u&&(S.length>0?confirm("Are you sure you want to Trade STC?")&&ApplyTradeActual(S.join(","),e,t,a,peakPayGstRate,peakPayTimePeriodValue,peakPayFeeValue,"SAAS"):alert("Please select atleast one job."))}else 4!=a&&8!=a&&12!=a&&4!=customSettlementTerm&&8!=customSettlementTerm&&12!=customSettlementTerm&&"true"==$("#IsApproachingExpiryDate").val().toLowerCase()?alert("Approaching 12-month expiry date for claiming STCs. This job can only be traded on approval. Please contact your account manager for further details."):ApplyTradeActual(model_JobId,e,t,a,peakPayGstRate,peakPayTimePeriodValue,peakPayFeeValue,"SAAS");else alert("Oops, there is an error in the backend, please contact a Greenbot admin");else alert("Please select atleast one settlement term.")}function ApplyTradeActual(e,t,a,s,r,o,i,l){var n=CompareJobData();n?$.ajax({url:urlApplyTradeSTC,type:"POST",data:{jobId:e,interval:t,price:a,settlementterm:s,isGst:model_IsGST,stcAmt:stcAmount,CustomSettlementTerm:customSettlementTerm,peakPayGst:r,peakPayTimeperiod:o,peakPayFee:i,TradeType:l,STCRemark:STCRemark},success:function(e){null!=e.jobIds?showMessageForSTC("There are some illegal characters in the serial number field. Job cannot be traded until these are amended with the correct serials.",!0):(showMessageForSTC("Job has been traded successfully.",!1),1!=ProjectSession_UserTypeId&&3!=ProjectSession_UserTypeId&&10!=$("#STCStatusId").val()&&12!=$("#STCStatusId").val()&&14!=$("#STCStatusId").val()&&17!=$("#STCStatusId").val()&&$("#btnSaveJob").hide(),"True"==isSaveJobAfterTrade&&$("#btnSaveJob").show(),ReloadSTCJobScreen(model_JobId),SearchHistory(),"undefined"!=typeof isDynamicJobIndex&&isDynamicJobIndex?(filterKendo=$("#datatable").data("kendoGrid").dataSource.filter(),datatableInfo(),GridConfig[0].IsKendoGrid?($("#datatable").kendoGrid("destroy").empty(),drawJobIndex(filterKendo)):($("#datatable").DataTable().destroy(),drawJobIndex())):($("#JobOwnerDetails_OwnerType").prop("disabled",!0),$("#JobInstallationDetails_PropertyType").prop("disabled",!0),$("#JobSystemDetails_SystemSize").prop("disabled",!0),$("#BasicDetails_strInstallationDate").prop("disabled",!0),$("#JobSystemDetails_SerialNumbers").prop("disabled",!0),$("#PricingBlock").hide()),10!=$("#STCStatusId").val()&&12!=$("#STCStatusId").val()&&14!=$("#STCStatusId").val()&&17!=$("#STCStatusId").val()&&($("#CESDocbtns").hide(),$("#STCDocBtns").hide(),$(".isdelete").css("display","none")),1!=session_UserTypeId&&3!=session_UserTypeId&&2!=session_UserTypeId&&4!=session_UserTypeId&&5!=session_UserTypeId||($("#CESDocbtns").show(),$("#STCDocBtns").show()),1!=session_UserTypeId&&3!=session_UserTypeId||$(".isdelete").css("display","block"))}}):alert("There are changes in this job that have not been saved. Before trading, please save your changes.")}function ShowHideJobs(e,t){$("#datatable1").find("tr").show(),$("#datatable1 tr td").each(function(){$(this).find("input[type=checkbox]").each(function(){isAllowKW=$(this).attr("isallowkw"),jobSizeForOptiPay=$(this).attr("jobsizeforoptipay"),isCommercialJob=$(this).attr("iscommercialjob"),isNonCommercialJob=$(this).attr("isnoncommercialjob"),isPeakPayCommercialJob=$(this).attr("isPeakPayCommercialJob"),isPeakPayNonCommercialJob=$(this).attr("isPeakPayNonCommercialJob"),isCustomAllowKW=$(this).attr("iscustomallowkw"),jobCustomSizeForOptiPay=$(this).attr("jobcustomsizeforoptipay"),isCustomCommercialJob=$(this).attr("iscustomcommercialjob"),isCustomNonCommercialJob=$(this).attr("iscustomnoncommercialjob"),isCustomPeakPayCommercialJob=$(this).attr("isCustomPeakPayCommercialJob"),isCustomPeakPayNonCommercialJob=$(this).attr("isCustomPeakPayNonCommercialJob"),modelIsGSTSetByAdminUser=$(this).attr("modelisgstsetbyadminuser"),isGst=$(this).attr("isgst").toLowerCase(),gstDocument=$(this).attr("gstdocument"),propType=$(this).attr("proptype").toLowerCase(),sysSize=$(this).attr("jobsystemsize"),ownerType=$(this).attr("ownerType").toLowerCase()}),7==e?CheckRuleofRapidPay(null,propType,$(this),ownerType):8==e?CheckRuleofOptiPay(isAllowKW,jobSizeForOptiPay,isCommercialJob,isNonCommercialJob,null,modelIsGSTSetByAdminUser,isGst,$(this),ownerType,propType):9==e?CheckRuleofCommercial(null,modelIsGSTSetByAdminUser,isGst,gstDocument,$(this),ownerType,propType):12==e?CheckRuleofPeakPay(isPeakPayCommercialJob,isPeakPayNonCommercialJob,null,modelIsGSTSetByAdminUser,isGst,$(this),ownerType,propType):10==e&&(7==t?CheckRuleofRapidPay(null,propType,$(this),ownerType):8==t?CheckRuleofOptiPay(isAllowKW,jobSizeForOptiPay,isCommercialJob,isNonCommercialJob,null,modelIsGSTSetByAdminUser,isGst,$(this),ownerType,propType):9==t?CheckRuleofCommercial(null,modelIsGSTSetByAdminUser,isGst,gstDocument,$(this),ownerType,propType):12==t&&CheckRuleofPeakPay(isCustomPeakPayCommercialJob,isCustomPeakPayNonCommercialJob,null,modelIsGSTSetByAdminUser,isGst,$(this),ownerType,propType))}),$("#chkAll1").prop("checked",!0),datatable1Chkbox($("#chkAll1").prop("checked"),!1)}var STCRemark="";$(".LiSettlement").click(function(){$(".LiSettlement").removeClass("active"),$(this).addClass("active")});